<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#16A34A">
    <meta name="description" content="Eitaki - Decode what's really inside your products. Scan ingredients and understand what you're consuming.">
    <title>Eitaki - Decode Every Ingredient</title>
    
    <!--
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    üå± Eitaki - Decode Every Ingredient
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    üí∞ ANALYSIS SOLUTION
    - Google Gemini Flash
    - Open Food Facts: 200K+ products
    - QuaggaJS Barcode
    
    
    üì¶ Features:
    - Barcode + Manual ingredient scanning
    - AI-powered analysis with source citations
    - Health scoring with WHO/FSSAI/FDA/FSSAI badges
    - Multi-language ingredient detection
    - Community verification (Phase 1)
    - Progressive email verification
    - Offline capability (PWA)
    
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    -->
    
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkVpdGFraSAtIFdoYXQncyBSZWFsbHkgSW5zaWRlPyIsCiAgInNob3J0X25hbWUiOiAiRWl0YWtpIiwKICAiZGVzY3JpcHRpb24iOiAiRGVjb2RlIHdoYXQncyByZWFsbHkgaW5zaWRlIHlvdXIgcHJvZHVjdHMiLAogICJzdGFydF91cmwiOiAiLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI0ZGRkZGRiIsCiAgInRoZW1lX2NvbG9yIjogIiMwRDk0ODgiLAogICJvcmllbnRhdGlvbiI6ICJwb3J0cmFpdCIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0NzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgMTAwIDEwMCclM0UlM0NyZWN0IGZpbGw9JyUyMzBEOTQ4OCcgd2lkdGg9JzEwMCcgaGVpZ2h0PScxMDAnLyUzRSUzQ3RleHQgeD0nNTAlMjUnIHk9JzUwJTI1JyBmb250LXNpemU9JzUwJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBkeT0nLjNlbSclM0Xwn5SNJTNDLzRleHQlM0UlM0Mvc3ZnJTNFIiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfSwKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgdmlld0JveD0nMCAwIDEwMCAxMDAnJTNFJTNDcmVjdCBmaWxsPSclMjMwRDk0ODgnIHdpZHRoPScxMDAnIGhlaWdodD0nMTAwJy8lM0UlM0N0ZXh0IHg9JzUwJTI1JyB5PSc1MCUyNScgZm9udC1zaXplPSc1MCcgdGV4dC1hbmNob3I9J21pZGRsZScgZHk9Jy4zZW0nJTNF8J+UjSUzQy90ZXh0JTNFJTNDL3N2ZyUzRSIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICAgIH0KICBdCn0=">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* BUG #18: Natural Green Color Scheme */
            /* PRIMARY PALETTE */
            --color-brand-primary: #16A34A;  /* Eitaki Green */
            --color-brand-primary-light: #86EFAC;
            --color-brand-primary-dark: #15803D;
            
            /* HEALTH SCORE COLORS */
            --color-score-excellent: #16A34A;  /* 85-100 */
            --color-score-good: #84CC16;       /* 70-84 */
            --color-score-fair: #EAB308;       /* 50-69 */
            --color-score-poor: #F97316;       /* 35-49 */
            --color-score-very-poor: #DC2626;  /* 0-34 */
            
            /* Legacy variables mapped to new scheme */
            --deep-teal: #16A34A;
            --vibrant-coral: #FF6B6B;
            --sunshine-yellow: #FFC93C;
            --pure-white: #FFFFFF;
            --ice-blue: #F0FDF4;
            --slate: #1E293B;
            --light-slate: #64748B;
            
            /* Trust Badges */
            --trust-green: #10B981;
            --caution-yellow: #F59E0B;
            --warning-red: #EF4444;
            
            /* Functional Colors */
            --color-success: #10B981;
            --color-warning: #F59E0B;
            --color-error: #EF4444;
            
            --shadow: rgba(0, 0, 0, 0.1);
            --shadow-lg: rgba(0, 0, 0, 0.15);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--pure-white);
            color: var(--slate);
            overflow-x: hidden;
            line-height: 1.6;
        }

        .app-container {
            max-width: 100%;
            min-height: 100vh;
            padding-bottom: 70px;
        }

        /* Header - Minimal */
        .header {
            background: var(--deep-teal);
            color: white;
            padding: 16px 20px;
            box-shadow: 0 2px 8px var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            font-size: 22px;
            font-weight: 700;
            display: flex;
            flex-direction: column;
            gap: 2px;
            letter-spacing: -0.5px;
        }

        .logo-name {
            font-size: 24px;
        }

        .logo-subtitle {
            font-size: 11px;
            opacity: 0.9;
            font-weight: 400;
            letter-spacing: 0.5px;
        }

        .icon-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
        }

        .icon-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        /* Views */
        .view {
            display: none;
            animation: fadeIn 0.3s;
        }

        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Onboarding */
        .onboarding-container {
            min-height: calc(100vh - 70px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
        }

        .onboarding-screen {
            display: none;
            max-width: 500px;
            width: 100%;
        }

        .onboarding-screen.active {
            display: block;
            animation: fadeIn 0.4s;
        }

        .onboarding-icon {
            font-size: 80px;
            margin-bottom: 24px;
        }

        .onboarding-title {
            font-size: 32px;
            font-weight: 700;
            color: var(--deep-teal);
            margin-bottom: 16px;
        }

        .onboarding-subtitle {
            font-size: 14px;
            color: var(--light-slate);
            margin-bottom: 24px;
            font-style: italic;
        }

        .onboarding-text {
            font-size: 18px;
            color: var(--light-slate);
            margin-bottom: 32px;
            line-height: 1.6;
        }

        .onboarding-list {
            text-align: left;
            margin: 24px 0;
            padding: 0 20px;
        }

        .onboarding-list li {
            font-size: 16px;
            color: var(--slate);
            margin-bottom: 12px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .btn {
            padding: 14px 32px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
        }

        .btn-primary {
            background: var(--deep-teal);
            color: white;
            box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);
        }

        .btn-primary:hover {
            background: #15803D;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(22, 163, 74, 0.4);
        }

        .btn-secondary {
            background: var(--ice-blue);
            color: var(--deep-teal);
        }

        .btn-secondary:hover {
            background: #E0F2FE;
        }

        /* Home View - Laser Focused */
        .home-hero {
            min-height: calc(100vh - 200px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
        }

        .hero-icon {
            font-size: 120px;
            margin-bottom: 32px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .hero-title {
            font-size: 36px;
            font-weight: 700;
            color: var(--slate);
            margin-bottom: 16px;
            line-height: 1.2;
        }

        .hero-subtitle {
            font-size: 18px;
            color: var(--light-slate);
            margin-bottom: 40px;
            max-width: 400px;
        }

        .scan-btn-large {
            background: linear-gradient(135deg, var(--deep-teal), #15803D);
            color: white;
            border: none;
            padding: 20px 48px;
            border-radius: 16px;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(22, 163, 74, 0.3);
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 12px;
            letter-spacing: 0.5px;
        }

        .scan-btn-large:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 32px rgba(22, 163, 74, 0.4);
        }

        .secondary-action {
            margin-top: 32px;
            color: var(--light-slate);
            font-size: 16px;
        }

        .text-link {
            color: var(--deep-teal);
            text-decoration: none;
            font-weight: 600;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .text-link:hover {
            border-bottom-color: var(--deep-teal);
        }

        .recent-scans {
            margin-top: 48px;
            max-width: 600px;
            width: 100%;
        }

        .recent-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--light-slate);
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .recent-items {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 8px;
        }

        .recent-item {
            background: var(--ice-blue);
            padding: 12px 20px;
            border-radius: 24px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .recent-item:hover {
            background: var(--deep-teal);
            color: white;
            transform: translateY(-2px);
        }

        /* Scanner View - Clean */
        .scanner-container {
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        .scanner-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .scanner-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--slate);
            margin-bottom: 8px;
        }

        .scanner-subtitle {
            font-size: 14px;
            color: var(--light-slate);
        }

        /* v1.2.1: Old .scan-mode-toggle and .mode-btn CSS removed - using floating badge */

        .camera-preview {
            position: relative;
            width: 100%;
            aspect-ratio: 3/4;
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 8px 24px var(--shadow-lg);
        }

        .camera-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            background: linear-gradient(135deg, var(--deep-teal), #15803D);
        }

        .placeholder-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .placeholder-text {
            font-size: 16px;
            opacity: 0.9;
        }

        .placeholder-subtext {
            font-size: 13px;
            opacity: 0.7;
            margin-top: 8px;
        }

        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
        }

        .scan-guide {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .capture-area {
            border: 3px dashed var(--sunshine-yellow);
            border-radius: 12px;
            height: 200px;
            margin: 20px 0;
        }

        .camera-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .capture-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 4px solid white;
            background: var(--vibrant-coral);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: white;
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
        }

        .capture-btn:hover {
            transform: scale(1.1);
        }

        .captured-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
            margin-top: 20px;
        }

        .captured-image {
            position: relative;
            aspect-ratio: 1;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid var(--ice-blue);
            box-shadow: 0 2px 8px var(--shadow);
        }

        .captured-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .remove-image {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--vibrant-coral);
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .btn-full {
            flex: 1;
        }

        /* Analysis View - Clean & Focused */
        .analysis-container {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .product-header {
            background: var(--pure-white);
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 2px 12px var(--shadow);
            margin-bottom: 20px;
            border-left: 4px solid var(--deep-teal);
        }

        .product-name {
            font-size: 24px;
            font-weight: 700;
            color: var(--slate);
            margin-bottom: 8px;
        }

        .product-brand {
            font-size: 16px;
            color: var(--light-slate);
            margin-bottom: 20px;
        }

        .health-score-card {
            background: var(--ice-blue);
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .score-main {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 16px;
        }

        .score-circle {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 28px;
            color: white;
            box-shadow: 0 4px 12px var(--shadow);
            flex-shrink: 0;
        }

        .score-label {
            font-size: 11px;
            font-weight: 600;
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .score-excellent { background: var(--trust-green); }
        .score-good { background: #93C47D; }
        .score-fair { background: var(--caution-yellow); }
        .score-poor { background: #F6B26B; }
        .score-bad { background: var(--warning-red); }

        .score-details {
            flex: 1;
        }

        .score-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 6px;
            color: var(--slate);
        }

        .score-desc {
            font-size: 14px;
            color: var(--light-slate);
            line-height: 1.6;
        }

        .trust-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .trust-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background: white;
            box-shadow: 0 2px 6px var(--shadow);
        }

        .trust-badge.verified {
            color: var(--trust-green);
            border: 1.5px solid var(--trust-green);
        }

        .trust-badge.caution {
            color: var(--caution-yellow);
            border: 1.5px solid var(--caution-yellow);
        }

        .trust-badge.warning {
            color: var(--warning-red);
            border: 1.5px solid var(--warning-red);
        }

        .alert-box {
            padding: 16px;
            background: #FEE2E2;
            border: 2px solid var(--warning-red);
            border-radius: 12px;
            color: #991B1B;
            margin: 16px 0;
            font-weight: 600;
        }

        .analysis-section {
            background: var(--pure-white);
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 2px 12px var(--shadow);
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--slate);
        }

        .ingredient-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .ingredient-item {
            padding: 16px;
            background: var(--ice-blue);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid var(--deep-teal);
        }

        .ingredient-item:hover {
            background: #E0F2FE;
            transform: translateX(4px);
            box-shadow: 0 2px 8px var(--shadow);
        }

        .ingredient-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .ingredient-name {
            font-weight: 700;
            font-size: 16px;
            color: var(--slate);
        }

        .impact-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .impact-positive {
            background: #D1FAE5;
            color: #065F46;
        }

        .impact-neutral {
            background: #E5E7EB;
            color: #374151;
        }

        .impact-negative {
            background: #FEE2E2;
            color: #991B1B;
        }

        .ingredient-purpose {
            font-size: 14px;
            color: var(--light-slate);
            margin-bottom: 4px;
        }

        .ingredient-detail {
            font-size: 13px;
            color: var(--slate);
            line-height: 1.6;
        }

        /* Donation Card */
        .donation-card {
            background: linear-gradient(135deg, var(--sunshine-yellow), #FFD966);
            padding: 24px;
            border-radius: 16px;
            margin: 20px;
            box-shadow: 0 8px 24px rgba(255, 201, 60, 0.3);
            max-width: 600px;
            margin: 20px auto;
        }

        .donation-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--slate);
            margin-bottom: 16px;
        }

        .donation-text {
            font-size: 15px;
            color: var(--slate);
            margin-bottom: 16px;
            line-height: 1.6;
        }

        .donation-benefits {
            margin: 16px 0;
            padding-left: 20px;
        }

        .donation-benefits li {
            font-size: 14px;
            color: var(--slate);
            margin-bottom: 8px;
            list-style-type: disc;
        }

        .donation-amounts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .donation-btn {
            background: white;
            border: 2px solid var(--slate);
            padding: 12px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .donation-btn:hover {
            background: var(--slate);
            color: white;
            transform: translateY(-2px);
        }

        .donation-footer {
            font-size: 13px;
            color: var(--slate);
            font-style: italic;
            text-align: center;
        }

        /* Settings View */
        .settings-section {
            background: var(--pure-white);
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 2px 12px var(--shadow);
            margin-bottom: 20px;
        }

        .settings-item {
            padding: 16px 0;
            border-bottom: 1px solid var(--ice-blue);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-label {
            font-weight: 600;
            color: var(--slate);
            margin-bottom: 8px;
        }

        .settings-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--ice-blue);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .settings-input:focus {
            outline: none;
            border-color: var(--deep-teal);
        }

        /* Bottom Navigation - Minimal */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--pure-white);
            border-top: 1px solid var(--ice-blue);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            box-shadow: 0 -4px 12px var(--shadow);
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 24px;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--light-slate);
            transition: all 0.3s;
            font-size: 12px;
            font-weight: 600;
        }

        .nav-item.active {
            color: var(--deep-teal);
        }

        .nav-icon {
            font-size: 24px;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 300px;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid var(--ice-blue);
            border-top-color: var(--deep-teal);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            font-weight: 600;
            color: var(--slate);
        }

        /* Email Verification Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 32px;
            border-radius: 20px;
            max-width: 450px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--slate);
            margin-bottom: 16px;
        }

        .modal-text {
            font-size: 15px;
            color: var(--light-slate);
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .form-input {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--ice-blue);
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 16px;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--deep-teal);
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
        }

        /* Disclaimer */
        .disclaimer {
            background: var(--ice-blue);
            padding: 16px;
            border-radius: 12px;
            font-size: 13px;
            color: var(--light-slate);
            margin-top: 20px;
            border-left: 4px solid var(--deep-teal);
        }

        .disclaimer strong {
            color: var(--slate);
        }

        /* Responsive */
        @media (max-width: 640px) {
            .hero-title {
                font-size: 28px;
            }

            .hero-icon {
                font-size: 80px;
            }

            .scan-btn-large {
                font-size: 18px;
                padding: 18px 36px;
            }

            .onboarding-title {
                font-size: 28px;
            }
        }

        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
    
        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           V1.2.0 NEW STYLES
           ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        
        /* Floating Mode Badge */
        .mode-badge {
            position: fixed;
            top: 80px;
            left: 16px;
            z-index: 200;
            background: rgba(22, 163, 74, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: white;
            padding: 10px 16px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);
            transition: all 0.3s ease;
            display: none;
            align-items: center;
            gap: 8px;
        }
        .mode-badge.visible { display: flex; }
        .mode-badge:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(22, 163, 74, 0.4); }
        .mode-badge.pulsing { animation: modePulse 2s ease-in-out infinite; }
        @keyframes modePulse {
            0%, 100% { box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3); }
            50% { box-shadow: 0 4px 24px rgba(22, 163, 74, 0.6); }
        }
        .mode-badge-arrow { font-size: 10px; transition: transform 0.2s; }
        .mode-badge.menu-open .mode-badge-arrow { transform: rotate(180deg); }
        
        /* Mode Menu */
        .mode-menu {
            position: fixed;
            top: 130px;
            left: 16px;
            z-index: 199;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            padding: 8px 0;
            min-width: 180px;
            opacity: 0;
            transform: translateY(-10px) scale(0.95);
            transition: all 0.2s;
            pointer-events: none;
        }
        .mode-menu.visible { opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; }
        .mode-menu-item { padding: 14px 20px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: background 0.15s; }
        .mode-menu-item:hover { background: #F0FDF4; }
        .mode-menu-item.active { color: #16A34A; font-weight: 600; }
        
        /* Glass Bottom Bar */
        .scanner-bottom-bar {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 150;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
            border-radius: 40px;
            padding: 12px 24px;
            display: none;
            align-items: center;
            gap: 20px;
        }
        .scanner-bottom-bar.visible { display: flex; }
        .bar-btn {
            position: relative;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            border: none;
            background: #F0FDF4;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            transition: all 0.2s;
        }
        .bar-btn:hover { background: #DCFCE7; transform: scale(1.05); }
        .bar-btn.capture { width: 68px; height: 68px; background: #16A34A; color: white; font-size: 28px; box-shadow: 0 4px 16px rgba(22,163,74,0.4); }
        .bar-btn.capture:hover { background: #15803D; }
        .bar-btn .badge { position: absolute; top: -4px; right: -4px; background: #EF4444; color: white; font-size: 11px; font-weight: 700; min-width: 20px; height: 20px; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        
        /* Toast */
        .toast-container { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); z-index: 9999; pointer-events: none; }
        .toast { background: rgba(30,41,59,0.95); color: white; padding: 14px 24px; border-radius: 28px; font-size: 14px; font-weight: 500; opacity: 0; transform: translateY(20px); transition: all 0.3s; pointer-events: auto; margin-bottom: 8px; }
        .toast.visible { opacity: 1; transform: translateY(0); }
        .toast.success { background: rgba(16,185,129,0.95); }
        .toast.warning { background: rgba(245,158,11,0.95); color: #1E293B; }
        .toast.error { background: rgba(239,68,68,0.95); }
        
        /* Quality Indicator */
        .quality-indicator { position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.75); color: white; padding: 8px 16px; border-radius: 24px; font-size: 12px; font-weight: 600; display: none; align-items: center; gap: 8px; }
        .quality-indicator.visible { display: flex; }
        .quality-dot { width: 8px; height: 8px; border-radius: 50%; }
        .quality-dot.good { background: #10B981; }
        .quality-dot.fair { background: #F59E0B; }
        .quality-dot.poor { background: #EF4444; }
        
        /* Auto-analyze Badge */
        .auto-analyze-badge { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); background: rgba(22,163,74,0.95); color: white; padding: 16px 24px; border-radius: 28px; font-size: 15px; font-weight: 600; display: none; align-items: center; gap: 10px; z-index: 20; }
        .auto-analyze-badge.visible { display: flex; animation: modePulse 1.5s infinite; }
        
        /* Swipeable Cards */
        .ingredient-carousel { position: relative; overflow: hidden; touch-action: pan-y; }
        .ingredient-cards-wrapper { display: flex; transition: transform 0.3s ease; }
        .ingredient-card { flex: 0 0 100%; min-width: 100%; padding: 0 16px; }
        .carousel-nav { display: flex; justify-content: center; align-items: center; gap: 16px; padding: 16px; }
        .carousel-dots { display: flex; gap: 6px; }
        .carousel-dot { width: 8px; height: 8px; border-radius: 50%; background: #D1D5DB; transition: all 0.2s; cursor: pointer; }
        .carousel-dot.active { background: #16A34A; width: 24px; border-radius: 4px; }
        .carousel-arrow { width: 36px; height: 36px; border-radius: 50%; border: 1px solid #E5E7EB; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: all 0.2s; }
        .carousel-arrow:hover:not(:disabled) { border-color: #16A34A; color: #16A34A; }
        .carousel-arrow:disabled { opacity: 0.3; cursor: not-allowed; }
        
        /* Voice Input */
        .input-with-mic { position: relative; }
        .input-with-mic input { padding-right: 48px; }
        .mic-btn { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); width: 36px; height: 36px; border-radius: 50%; border: none; background: #F3F4F6; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: all 0.2s; }
        .mic-btn:hover { background: #F0FDF4; }
        .mic-btn.listening { background: #EF4444; color: white; animation: modePulse 1s infinite; }
        .mic-btn.hidden { display: none; }
        
        /* Confidence Badge */
        .confidence-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; margin-top: 12px; }
        .confidence-badge.high { background: rgba(16,185,129,0.15); color: #059669; }
        .confidence-badge.medium { background: rgba(245,158,11,0.15); color: #D97706; }
        .confidence-badge.low { background: rgba(239,68,68,0.15); color: #DC2626; }
        
        /* Safety Levels */
        .safety-level { display: inline-flex; align-items: center; gap: 4px; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .safety-level.safe { background: rgba(16,185,129,0.15); color: #059669; }
        .safety-level.moderate { background: rgba(245,158,11,0.15); color: #D97706; }
        .safety-level.limit { background: rgba(249,115,22,0.15); color: #EA580C; }
        .safety-level.avoid { background: rgba(239,68,68,0.15); color: #DC2626; }
        
        /* Score Explainer */
        .score-explainer { margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(0,0,0,0.1); }
        .explainer-toggle { background: none; border: none; color: #16A34A; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px; padding: 0; }
        .explainer-content { margin-top: 16px; padding: 16px; background: white; border-radius: 8px; display: none; }
        .explainer-content.visible { display: block; }
        .pillar-item { display: flex; align-items: center; gap: 16px; margin-bottom: 12px; }
        .pillar-weight { width: 40px; height: 40px; border-radius: 8px; background: #F0FDF4; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; color: #16A34A; flex-shrink: 0; }
        .pillar-name { font-size: 14px; font-weight: 600; color: #1E293B; }
        .pillar-desc { font-size: 12px; color: #64748B; }
        
        /* v1.2.2: Crop Modal */
        .crop-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            flex-direction: column;
        }
        .crop-modal.active { display: flex; }
        .crop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: rgba(0,0,0,0.5);
        }
        .crop-header h3 { color: white; margin: 0; font-size: 18px; }
        .crop-header button {
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 8px;
        }
        .crop-header button:hover { background: rgba(255,255,255,0.1); }
        .crop-header .crop-done { background: #16A34A; font-weight: 600; }
        .crop-header .crop-done:hover { background: #15803D; }
        .crop-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }
        .crop-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            touch-action: none;
        }
        .crop-overlay {
            position: absolute;
            border: 2px dashed #16A34A;
            background: rgba(22, 163, 74, 0.1);
            pointer-events: none;
        }
        .crop-instructions {
            padding: 12px;
            text-align: center;
            color: #94A3B8;
            font-size: 14px;
            background: rgba(0,0,0,0.5);
        }
        
        /* v1.2.2: Mini Recent Scans on Scanner Page */
        .scanner-mini-history {
            position: fixed;
            bottom: 100px;
            left: 16px;
            right: 16px;
            z-index: 140;
            display: none;
        }
        .scanner-mini-history.visible { display: block; }
        .mini-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            border-radius: 12px 12px 0 0;
        }
        .mini-history-header span { color: white; font-size: 12px; font-weight: 600; }
        .mini-history-toggle {
            background: none;
            border: none;
            color: #16A34A;
            font-size: 12px;
            cursor: pointer;
        }
        .mini-history-list {
            display: flex;
            gap: 8px;
            padding: 8px;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(10px);
            border-radius: 0 0 12px 12px;
            overflow-x: auto;
        }
        .mini-history-item {
            flex-shrink: 0;
            width: 80px;
            padding: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
        }
        .mini-history-item:hover { background: rgba(255,255,255,0.2); }
        .mini-history-score {
            font-size: 18px;
            font-weight: 700;
            color: white;
        }
        .mini-history-name {
            font-size: 10px;
            color: #94A3B8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    
    </style>
</head>
<body>

    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-name">üå± Eitaki</div>
                    <div class="logo-subtitle">Decode Every Ingredient</div>
                </div>
                <div>
                    <button class="icon-btn" onclick="app.showView('settings')" aria-label="Settings">
                        ‚öôÔ∏è
                    </button>
                </div>
            </div>
        </header>

        <!-- Onboarding - v1.2.1: Single screen -->
        <div id="view-onboarding" class="view active">
            <div class="onboarding-container">
                <div class="onboarding-screen active" id="onboarding-1">
                    <div class="onboarding-icon">üå±</div>
                    <h1 class="onboarding-title">Welcome to Eitaki</h1>
                    <p class="onboarding-text">
                        Decode ingredients in everyday products.<br>
                        <strong>No signup required.</strong>
                    </p>
                    
                    <div style="text-align: left; margin: 24px 0; padding: 16px; background: rgba(22, 163, 74, 0.1); border-radius: 12px;">
                        <div style="margin-bottom: 12px; display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 24px;">üì∏</span>
                            <span>Scan barcode or ingredient list</span>
                        </div>
                        <div style="margin-bottom: 12px; display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 24px;">üî¨</span>
                            <span>Get AI-powered analysis</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 24px;">üíö</span>
                            <span>Make informed choices</span>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="app.completeOnboarding()" style="width: 100%; font-size: 18px; padding: 16px;">
                        Start Scanning ‚Üí
                    </button>
                    
                    <p style="margin-top: 16px; font-size: 12px; color: #64748B; text-align: center;">
                        üîí Your data stays on your device ‚Ä¢ üíö No ads
                    </p>
                </div>
            </div>
        </div>

        <!-- Home View - Laser Focused -->
        <div id="view-home" class="view">
            <div style="background: linear-gradient(135deg, #F0FDF4, #DCFCE7); padding: 12px 20px; text-align: center; font-size: 14px; font-weight: 600; color: #166534; border-bottom: 2px solid #86EFAC;">
                üß™ Beta Testing Phase - Help us improve! <a href="https://forms.gle/vnhGDgAVUUeid1SY8" style="color: #16A34A; text-decoration: underline;">Share Feedback</a>
            </div>
            <div class="home-hero">
                <div class="hero-icon" role="img" aria-label="Plant seedling">üå±</div>
                <h1 class="hero-title">
                    Decode Every<br>Ingredient
                </h1>
                <p class="hero-subtitle">
                    Scan any product and decode complex ingredients in seconds
                </p>
                <button class="scan-btn-large" onclick="app.showView('scanner')" aria-label="Start scanning products">
                    üì∏ SCAN PRODUCT
                </button>
                <!-- v1.2.1: Search link removed - Phase 1.5 feature -->
                
                <div class="recent-scans" id="recent-scans-container" style="display: none;">
                    <div class="recent-title">Recent Scans</div>
                    <div class="recent-items" id="recent-items"></div>
                </div>
            </div>

            <!-- Donation Card - Hidden in Beta -->
            <div class="donation-card" style="display: none;">
                <h3 class="donation-title">üíö Help Us Decode More Products</h3>
                <p class="donation-text">
                    Every day, families trust us to decode what's really inside their food, shampoo, and baby products.
                </p>
                <div class="donation-text" style="margin-top: 12px;">
                    <strong>Your support means:</strong>
                </div>
                <ul class="donation-benefits">
                    <li>1,000+ more products analyzed monthly</li>
                    <li>Faster scans for everyone</li>
                    <li>No ads, ever (we promise!)</li>
                </ul>
                <div class="donation-amounts">
                    <button class="donation-btn" onclick="app.donate(20)">‚Çπ20<br><small>One chai</small></button>
                    <button class="donation-btn" onclick="app.donate(50)">‚Çπ50<br><small>Samosa party</small></button>
                    <button class="donation-btn" onclick="app.donate(100)">‚Çπ100<br><small>Full meal</small></button>
                    <button class="donation-btn" onclick="app.donateCustom()">Custom</button>
                </div>
                <div class="donation-footer">
                    Made with üíö by people who believe you deserve to know what you're consuming
                </div>
            </div>
        </div>

        <!-- Scanner View -->
        <div id="view-scanner" class="view">
            <!-- v1.2.1: X close button -->
            <button onclick="app.showView('home')" style="position: fixed; top: 16px; right: 16px; z-index: 200; width: 40px; height: 40px; border-radius: 50%; border: none; background: rgba(0,0,0,0.5); color: white; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                ‚úï
            </button>
            
            <!-- Floating Mode Badge (v1.2.0) -->
            <div class="mode-badge visible" id="mode-badge" onclick="app.toggleModeMenu()">
                <span id="mode-badge-icon">üìã</span>
                <span id="mode-badge-text">Ingredients</span>
                <span class="mode-badge-arrow">‚ñº</span>
            </div>
            <div class="mode-menu" id="mode-menu">
                <div class="mode-menu-item active" id="menu-ingredients" onclick="app.selectMode('ingredients')">üìã Ingredients</div>
                <div class="mode-menu-item" id="menu-barcode" onclick="app.selectMode('barcode')">üìä Barcode</div>
            </div>

            <div class="scanner-container">
                <div class="scanner-header">
                    <h2 class="scanner-title">Scan Product</h2>
                    <p class="scanner-subtitle" id="scanner-subtitle">Point at ingredient list</p>
                </div>

                <!-- v1.2.1: Old tabs removed - using floating badge only -->

                <div class="camera-preview">
                    <video id="camera-video" class="camera-video" autoplay playsinline style="display:none;" aria-label="Camera preview"></video>
                    <div id="camera-placeholder" class="camera-placeholder">
                        <div class="placeholder-icon">üì∏</div>
                        <div class="placeholder-text">Camera will start automatically</div>
                        <div class="placeholder-subtext">Or tap Gallery below to upload</div>
                    </div>
                    
                    <div class="quality-indicator" id="quality-indicator">
                        <span class="quality-dot" id="quality-dot"></span>
                        <span id="quality-text">Checking...</span>
                    </div>
                    <div class="auto-analyze-badge" id="auto-analyze-badge">‚ú® Auto-analyzing...</div>
                    <div class="camera-overlay" style="display:none;" id="camera-overlay">
                        <div class="scan-guide" role="status" aria-live="polite" id="scan-guide-text">
                            üìã Point at ingredient list
                        </div>
                        <div class="capture-area" aria-hidden="true"></div>
                    </div>
                </div>

                <div class="captured-images" id="captured-images" role="list" aria-label="Captured images"></div>

                <!-- BUG #2: Hidden file input for gallery fallback -->
                <input type="file" id="file-input-fallback" accept="image/*" style="display: none;" onchange="app.handleGalleryUpload(event)">

                <!-- BUG #3: Scanner result area for quality feedback and errors -->
                <div id="scanner-result" style="display: none;"></div>

                <!-- v1.2.0: Old action buttons removed - using glass morphism bottom bar instead -->
            </div>
        
            <!-- Glass Morphism Bottom Bar (v1.2.0) -->
            <div class="scanner-bottom-bar" id="scanner-bottom-bar">
                <button class="bar-btn" onclick="app.openGallery()" aria-label="Gallery">üñºÔ∏è<span class="badge" id="photo-count-badge" style="display:none;">0</span></button>
                <button class="bar-btn capture" id="capture-btn-main" onclick="app.capturePhoto()" aria-label="Capture">üì∑</button>
                <button class="bar-btn" id="analyze-btn-bar" onclick="app.analyzeProduct()" aria-label="Analyze" disabled>‚úì</button>
            </div>
            
            <!-- v1.2.2: Mini Recent Scans -->
            <div class="scanner-mini-history" id="scanner-mini-history">
                <div class="mini-history-header">
                    <span>üìú Recent Scans</span>
                    <button class="mini-history-toggle" onclick="app.toggleMiniHistory()">Hide</button>
                </div>
                <div class="mini-history-list" id="mini-history-list">
                    <!-- Populated dynamically -->
                </div>
            </div>

        </div>
        
        <!-- v1.2.2: Crop Modal -->
        <div class="crop-modal" id="crop-modal">
            <div class="crop-header">
                <button onclick="app.cancelCrop()">Cancel</button>
                <h3>Crop Image</h3>
                <button class="crop-done" onclick="app.applyCrop()">Done</button>
            </div>
            <div class="crop-container" id="crop-container">
                <img id="crop-image" class="crop-image" src="" alt="Image to crop">
                <div class="crop-overlay" id="crop-overlay"></div>
            </div>
            <div class="crop-instructions">
                Pinch to zoom ‚Ä¢ Drag to position ‚Ä¢ Focus on ingredient list
            </div>
        </div>

        <!-- Analysis View -->
        <div id="view-analysis" class="view">
            <div class="analysis-container" id="analysis-content" role="main">
                <!-- Populated dynamically -->
            </div>
        </div>

        <!-- Settings View - BUG #11: Simplified Profile -->
        <div id="view-settings" class="view">
            <div class="analysis-container">
                <h2 class="section-title">‚öôÔ∏è Settings</h2>
                
                <!-- BUG #11: Simplified Profile Section -->
                <div class="settings-section">
                    <h3 style="margin-bottom: 16px;">üì∏ Profile</h3>
                    <div class="settings-item">
                        <div class="settings-label">Name</div>
                        <div class="input-with-mic"><input type="text" class="settings-input" id="setting-name" placeholder="Your name"><button class="mic-btn" onclick="app.startVoiceInput('setting-name')" aria-label="Voice">üé§</button></div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-label">Food Allergies</div>
                        <div class="input-with-mic"><input type="text" class="settings-input" id="setting-allergies" placeholder="e.g., peanuts, dairy, gluten">
                        <p style="font-size: 12px; color: var(--light-slate); margin-top: 4px;">
                            Separate multiple allergies with commas
                        </p>
                    </div>
                    <button class="btn btn-primary" onclick="app.saveSettings()" style="margin-top: 16px; width: 100%;">
                        Save Settings
                    </button>
                </div>

                <!-- Scan History (Simplified) -->
                <div class="settings-section">
                    <h3 style="margin-bottom: 16px;">üìú Scan History</h3>
                    <div id="scan-history-list" style="max-height: 200px; overflow-y: auto;">
                        <p style="color: var(--light-slate); font-size: 14px;">Your recent scans will appear here.</p>
                    </div>
                </div>

                <!-- BUG #13: About & Legal Section -->
                <div class="settings-section">
                    <h3 style="margin-bottom: 16px;">‚ÑπÔ∏è About & Legal</h3>
                    <div style="background: #F0FDF4; padding: 12px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #16A34A;">
                        <strong>üß™ Beta Version</strong><br>
                        Testing with early users. Community features launching soon!
                    </div>
                    <p style="line-height: 1.8; color: var(--slate); margin-bottom: 16px;">
                        Eitaki helps you decode what's really inside the products you use every day. From Delhi to Dubai, Mumbai to Manhattan‚Äîwe believe everyone deserves food transparency.
                    </p>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <a href="#" onclick="app.showAbout(); return false;" style="color: #16A34A;">üå± About Eitaki</a>
                        <a href="#" onclick="app.showMethodology(); return false;" style="color: #16A34A;">üî¨ How We Calculate Scores</a>
                        <a href="#" onclick="app.showPrivacyPolicy(); return false;" style="color: #16A34A;">üîí Privacy Policy</a>
                        <a href="#" onclick="app.showTerms(); return false;" style="color: #16A34A;">üìã Terms of Service</a>
                    </div>
                </div>

                <div class="settings-section">
                    <h3 style="margin-bottom: 16px;">üîí Data & Privacy</h3>
                    <p style="line-height: 1.8; color: var(--slate); margin-bottom: 16px;">
                        ‚Ä¢ Your personal information is never sold or shared<br>
                        ‚Ä¢ We use industry-standard security practices<br>
                        ‚Ä¢ Analytics are anonymous and used only to improve the app<br>
                        ‚Ä¢ You control your data‚Äîdelete anytime below
                    </p>
                    <button class="btn btn-secondary" onclick="app.clearAllData()" style="width: 100%;">
                        Clear My Data
                    </button>
                </div>
            </div>
        </div>

        <!-- BUG #13: About Us Page -->
        <div id="view-about" class="view">
            <div class="analysis-container">
                <div style="max-width: 600px; margin: 0 auto; line-height: 1.8;">
                    <h1 style="font-size: 28px; font-weight: 700; margin-bottom: 24px; color: #111827;">
                        About Eitaki
                    </h1>
                    
                    <section style="margin-bottom: 32px;">
                        <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 12px; color: #16A34A;">
                            üå± Our Mission
                        </h2>
                        <p style="color: #374151; margin-bottom: 12px;">
                            Everyone who consumes packaged products deserves to understand what's inside them.
                        </p>
                        <p style="color: #374151; margin-bottom: 12px;">
                            Ingredient lists can be confusing‚Äîlong chemical names, unfamiliar codes, and tiny print make it hard to know what you're really eating.
                        </p>
                        <p style="color: #374151;">
                            From Delhi to Dubai, Mumbai to Manhattan, Bangalore to Boston‚ÄîEitaki helps you decode ingredients, make intelligent choices, and keep your family safe.
                        </p>
                    </section>
                    
                    <section style="margin-bottom: 32px;">
                        <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 12px; color: #16A34A;">
                            üíö Why We Exist
                        </h2>
                        <p style="color: #374151;">
                            Reading ingredient labels shouldn't require a chemistry degree. We believe transparency should be accessible to everyone‚Äîwhether you're shopping at a local store or browsing online from your couch.
                        </p>
                    </section>
                    
                    <section style="margin-bottom: 32px;">
                        <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 12px; color: #16A34A;">
                            üî¨ How It Works
                        </h2>
                        <ol style="padding-left: 20px; color: #374151;">
                            <li style="margin-bottom: 8px;"><strong>Scan</strong>: Point your camera at any ingredient list</li>
                            <li style="margin-bottom: 8px;"><strong>Learn</strong>: Get instant analysis of what's inside</li>
                            <li style="margin-bottom: 8px;"><strong>Decide</strong>: Make informed choices for your family</li>
                            <li><strong>Contribute</strong>: (Optional) Help others by adding products</li>
                        </ol>
                    </section>
                    
                    <section style="margin-bottom: 32px;">
                        <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 12px; color: #16A34A;">
                            ü§ù Our Values
                        </h2>
                        <div style="margin-bottom: 12px;">
                            <strong style="color: #111827;">üå± Built for Everyone, Everywhere</strong><br>
                            <span style="color: #6B7280; font-size: 14px;">No ads, no paywalls, no boundaries</span>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <strong style="color: #111827;">üíö Honest & Transparent</strong><br>
                            <span style="color: #6B7280; font-size: 14px;">We share sources, admit limitations, and never hide our methods</span>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <strong style="color: #111827;">ü§ù Community-Powered</strong><br>
                            <span style="color: #6B7280; font-size: 14px;">Built by people who care, for people who care</span>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <strong style="color: #111827;">üìö Educational, Not Judgmental</strong><br>
                            <span style="color: #6B7280; font-size: 14px;">We provide facts, you make choices</span>
                        </div>
                        <div>
                            <strong style="color: #111827;">üî¨ Evidence-Based</strong><br>
                            <span style="color: #6B7280; font-size: 14px;">Every rating backed by WHO, FSSAI, and peer-reviewed research</span>
                        </div>
                    </section>
                    
                    <section style="margin-bottom: 32px;">
                        <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 12px; color: #16A34A;">
                            ‚öôÔ∏è The Technology
                        </h2>
                        <p style="color: #374151; margin-bottom: 12px;">
                            Eitaki uses AI technology to read ingredient lists and cross-reference them with health and safety databases.
                        </p>
                        <p style="color: #374151; font-style: italic; font-size: 14px;">
                            Remember: AI accuracy depends on photo quality. Clear photos help us deliver reliable results.
                        </p>
                    </section>
                    
                    <section>
                        <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 12px; color: #16A34A;">
                            üì¨ Get in Touch
                        </h2>
                        <p style="color: #374151; margin-bottom: 12px;">
                            Questions? Feedback? We'd love to hear from you!
                        </p>
                        <a href="https://forms.gle/vnhGDgAVUUeid1SY8" style="color: #16A34A; text-decoration: underline;">
                            Share Feedback
                        </a>
                    </section>
                </div>
                
                <div style="text-align: center; margin-top: 32px;">
                    <button class="btn btn-secondary" onclick="app.showView('home')">‚Üê Back to Home</button>
                </div>
            </div>
        </div>

        <!-- BUG #19: Footer with Legal Disclaimer (shown in analysis view) -->
        <footer id="app-footer" style="display: none; background: #F9FAFB; padding: 24px; text-align: center; border-top: 1px solid #E5E7EB; margin-bottom: 70px;">
            <div style="max-width: 600px; margin: 0 auto;">
                <div style="background: #FEF3C7; border-left: 4px solid #F59E0B; padding: 16px; border-radius: 8px; text-align: left; margin-bottom: 20px;">
                    <strong style="color: #92400E; display: block; margin-bottom: 8px;">
                        ‚ö†Ô∏è IMPORTANT DISCLAIMER
                    </strong>
                    <p style="font-size: 13px; color: #78350F; margin: 0; line-height: 1.6;">
                        Eitaki provides educational information about food ingredients based on publicly available research and regulatory data. This information is NOT medical advice and should not replace consultation with a qualified healthcare professional. By using Eitaki, you acknowledge that you use this information at your own risk.
                    </p>
                </div>
                
                <div style="font-size: 13px; color: #6B7280; margin-bottom: 16px;">
                    <a href="#" onclick="app.showAbout(); return false;" style="color: #16A34A; margin: 0 12px;">About</a>
                    <a href="#" onclick="app.showPrivacyPolicy(); return false;" style="color: #16A34A; margin: 0 12px;">Privacy</a>
                    <a href="#" onclick="app.showTerms(); return false;" style="color: #16A34A; margin: 0 12px;">Terms</a>
                </div>
                
                <div style="font-size: 12px; color: #9CA3AF;">
                    Made with üíö by people who believe you deserve to know what you're consuming
                </div>
            </div>
        </footer>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav" role="navigation" aria-label="Main navigation">
            <button class="nav-item" onclick="app.showView('home')" aria-label="Home">
                <span class="nav-icon" aria-hidden="true">üè†</span>
                <span>Home</span>
            </button>
            <button class="nav-item" onclick="app.showView('scanner')" aria-label="Scan product">
                <span class="nav-icon" aria-hidden="true">üì∏</span>
                <span>Scan</span>
            </button>
            <button class="nav-item" onclick="app.showView('settings')" aria-label="Settings">
                <span class="nav-icon" aria-hidden="true">‚öôÔ∏è</span>
                <span>Settings</span>
            </button>
        </nav>

        
        <!-- Toast Container (v1.2.0) -->
        <div class="toast-container" id="toast-container"></div>

        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loading-overlay" role="alert" aria-live="assertive">
            <div class="loading-content">
                <div class="spinner" aria-hidden="true"></div>
                <div class="loading-text" id="loading-message">Analyzing product...</div>
            </div>
        </div>

        <!-- v1.2.1: Email Verification Modal removed - Phase 1.5 feature -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quagga/dist/quagga.min.js"></script>
    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // BUG #2 & #4: Error Codes System for actionable error messages
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const ERROR_CODES = {
            CAMERA_DENIED: {
                code: 'ERR_001',
                title: 'üì∑ Camera Access Needed',
                message: 'Eitaki needs camera access to scan products.',
                actions: [
                    '1. Tap your browser settings (‚ãÆ)',
                    '2. Find "Site settings" or "Permissions"',
                    '3. Enable Camera for this site',
                    '4. Refresh and try again'
                ],
                fallback: 'Or upload a photo from your gallery instead'
            },
            CAMERA_UNAVAILABLE: {
                code: 'ERR_002',
                title: 'üì∑ Camera Not Available',
                message: 'Your device camera couldn\'t be accessed.',
                actions: [
                    'Check if another app is using the camera',
                    'Try closing other camera apps',
                    'Restart your browser'
                ],
                fallback: 'You can upload a photo from gallery'
            },
            ANALYSIS_FAILED: {
                code: 'ERR_005',
                title: 'üî¨ Analysis Failed',
                message: 'We couldn\'t analyze this image.',
                actions: [
                    'Check your internet connection',
                    'Try taking a clearer photo',
                    'Make sure the ingredient list is visible'
                ],
                fallback: 'Try uploading from gallery'
            },
            BARCODE_NOT_FOUND: {
                code: 'ERR_003',
                title: 'üìä Product Not Found',
                message: 'This barcode isn\'t in our database yet.',
                actions: [
                    'Try scanning the ingredient list instead',
                    'Help by adding this product later'
                ],
                fallback: 'switchToIngredients',  // v1.2.0: Auto-switch action
                fallbackText: 'üìã Scan Ingredients Instead'
            }
        };

        const app = {
            currentView: 'onboarding',
            onboardingStep: 1,
            cameraActive: false,
            cameraPermissionDenied: false, // C2: Cache permission denial
            capturedImages: [],
            stream: null,
            scanCount: 0,
            recentScans: [],
            scanMode: 'ingredients',  // v1.2.0: Default to ingredients mode (our differentiator)
            userSettings: {},
            photoAttempt: 1,  // BUG #3: Track photo attempts for quality feedback
            lastAnalysisConfidence: 100,  // BUG #5: Track confidence for display
            // v1.2.2: Crop state
            cropImageData: null,
            cropScale: 1,
            cropX: 0,
            cropY: 0,
            miniHistoryVisible: true,

            init() {
                // Check if onboarding already completed
                const onboardingComplete = localStorage.getItem('onboarding_complete');
                if (onboardingComplete === 'true') {
                    this.completeOnboarding();
                }
                
                this.scanCount = parseInt(localStorage.getItem('scan_count') || '0');
                this.loadRecentScans();
                this.loadSettings();
                this.setupEventListeners();
                this.updateScanHistoryDisplay();  // BUG #11: Show scan history
                this.miniHistoryVisible = localStorage.getItem('miniHistoryVisible') !== 'false';
            },

            setupEventListeners() {
                document.getElementById('capture-btn')?.addEventListener('click', () => this.captureImage());
            },

            loadSettings() {
                try {
                    const saved = localStorage.getItem('user_settings');
                    if (saved) {
                        this.userSettings = JSON.parse(saved);
                        // Populate form fields - BUG #11: Removed email and dietary preferences
                        if (document.getElementById('setting-name')) {
                            document.getElementById('setting-name').value = this.userSettings.name || '';
                            document.getElementById('setting-allergies').value = this.userSettings.allergies || '';
                        }
                    }
                } catch (e) {
                    console.error('Failed to load settings:', e);
                    this.userSettings = {};
                }
            },


            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // V1.2.0 NEW FUNCTIONS
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            
            QUALITY_THRESHOLDS: { AUTO_ANALYZE: 95, GOOD: 85, ACCEPTABLE: 80, MARGINAL: 75 },
            photoAttempts: 0,
            maxPhotos: 3,
            currentIngredientIndex: 0,
            touchStartX: 0,
            
            toggleModeMenu() {
                const menu = document.getElementById('mode-menu');
                const badge = document.getElementById('mode-badge');
                menu?.classList.toggle('visible');
                badge?.classList.toggle('menu-open');
                if (!localStorage.getItem('mode_badge_discovered')) {
                    localStorage.setItem('mode_badge_discovered', 'true');
                    badge?.classList.remove('pulsing');
                }
            },
            
            selectMode(mode) {
                this.scanMode = mode;
                localStorage.setItem('scan_mode', mode);
                this.updateModeUI();
                document.getElementById('mode-menu')?.classList.remove('visible');
                document.getElementById('mode-badge')?.classList.remove('menu-open');
                this.showToast(`Switched to ${mode === 'barcode' ? 'Barcode' : 'Ingredients'} mode`);
            },
            
            updateModeUI() {
                const icon = document.getElementById('mode-badge-icon');
                const text = document.getElementById('mode-badge-text');
                if (this.scanMode === 'ingredients') {
                    if (icon) icon.textContent = 'üìã';
                    if (text) text.textContent = 'Ingredients';
                    document.getElementById('menu-ingredients')?.classList.add('active');
                    document.getElementById('menu-barcode')?.classList.remove('active');
                } else {
                    if (icon) icon.textContent = 'üìä';
                    if (text) text.textContent = 'Barcode';
                    document.getElementById('menu-barcode')?.classList.add('active');
                    document.getElementById('menu-ingredients')?.classList.remove('active');
                }
            },
            
            showToast(message, type = 'info', duration = 3000) {
                const container = document.getElementById('toast-container');
                if (!container) return;
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                container.appendChild(toast);
                requestAnimationFrame(() => toast.classList.add('visible'));
                setTimeout(() => { toast.classList.remove('visible'); setTimeout(() => toast.remove(), 300); }, duration);
            },
            
            async checkPhotoQuality(imageData) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const scale = Math.min(200 / img.width, 200 / img.height);
                        canvas.width = img.width * scale;
                        canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
                        let totalBrightness = 0;
                        for (let i = 0; i < data.length; i += 4) totalBrightness += (0.299*data[i] + 0.587*data[i+1] + 0.114*data[i+2]);
                        const avgBrightness = totalBrightness / (data.length / 4);
                        const brightnessScore = Math.min(100, (avgBrightness / 128) * 100);
                        let sumSquares = 0;
                        for (let i = 0; i < data.length; i += 4) { const lum = 0.299*data[i] + 0.587*data[i+1] + 0.114*data[i+2]; sumSquares += Math.pow(lum - avgBrightness, 2); }
                        const contrastScore = Math.min(100, (Math.sqrt(sumSquares / (data.length / 4)) / 50) * 100);
                        let laplacianSum = 0;
                        for (let y = 1; y < canvas.height - 1; y++) for (let x = 1; x < canvas.width - 1; x++) { const idx = (y * canvas.width + x) * 4; laplacianSum += Math.abs(4*data[idx] - data[idx-4] - data[idx+4] - data[idx-canvas.width*4] - data[idx+canvas.width*4]); }
                        const sharpnessScore = Math.min(100, (laplacianSum / ((canvas.width-2) * (canvas.height-2))) * 2);
                        resolve({ score: Math.round(0.4*sharpnessScore + 0.3*brightnessScore + 0.3*contrastScore) });
                    };
                    img.src = imageData;
                });
            },
            
            async handleQualityResult(quality, imageData) {
                this.photoAttempts++;
                const T = this.QUALITY_THRESHOLDS;
                if (quality.score >= T.AUTO_ANALYZE) { this.capturedImages.push(imageData); this.renderCapturedImages(); this.autoAnalyze(); }
                else if (quality.score >= T.GOOD) { this.capturedImages.push(imageData); this.renderCapturedImages(); this.showToast('Great photo! üì∏', 'success'); document.getElementById('analyze-btn-bar').disabled = false; }
                else if (quality.score >= T.ACCEPTABLE) { this.capturedImages.push(imageData); this.renderCapturedImages(); document.getElementById('analyze-btn-bar').disabled = false; }
                else if (quality.score >= T.MARGINAL && this.photoAttempts > 1) { if (confirm('Photo quality is marginal. Continue anyway?')) { this.capturedImages.push(imageData); this.renderCapturedImages(); document.getElementById('analyze-btn-bar').disabled = false; this.showToast('Photo added with warning', 'warning'); } }
                else { this.showToast('Photo too blurry. Please retake.', 'error'); }
                this.updatePhotoCountBadge();
            },
            
            autoAnalyze() {
                const badge = document.getElementById('auto-analyze-badge');
                badge?.classList.add('visible');
                setTimeout(() => { badge?.classList.remove('visible'); this.analyzeProduct(); }, 800);
            },
            
            updatePhotoCountBadge() {
                const badge = document.getElementById('photo-count-badge');
                if (badge) { badge.textContent = this.capturedImages.length; badge.style.display = this.capturedImages.length > 0 ? 'flex' : 'none'; }
            },
            
            openGallery() {
                const input = document.createElement('input');
                input.type = 'file'; input.accept = 'image/*';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            if (this.capturedImages.length < this.maxPhotos) {
                                this.capturedImages.push(ev.target.result);
                                this.renderCapturedImages();
                                document.getElementById('analyze-btn-bar').disabled = false;
                                this.updatePhotoCountBadge();
                                this.showToast('Photo added', 'success');
                            } else { this.showToast('Maximum 3 photos', 'warning'); }
                        };
                        reader.readAsDataURL(file);
                    }
                };
                input.click();
            },
            
            startVoiceInput(inputId) {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) { this.showToast('Voice not supported', 'warning'); return; }
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                recognition.lang = 'en-IN'; recognition.continuous = false;
                const input = document.getElementById(inputId);
                const micBtn = input?.parentElement?.querySelector('.mic-btn');
                recognition.onstart = () => micBtn?.classList.add('listening');
                recognition.onresult = (e) => { if (input) input.value = input.value ? `${input.value}, ${e.results[0][0].transcript}` : e.results[0][0].transcript; };
                recognition.onerror = () => this.showToast('Voice failed', 'error');
                recognition.onend = () => micBtn?.classList.remove('listening');
                recognition.start();
            },
            
            initIngredientCarousel() {
                this.currentIngredientIndex = 0;
                const carousel = document.getElementById('ingredient-carousel');
                if (!carousel) return;
                carousel.addEventListener('touchstart', (e) => { this.touchStartX = e.touches[0].clientX; }, { passive: true });
                carousel.addEventListener('touchend', (e) => { const diff = this.touchStartX - e.changedTouches[0].clientX; if (Math.abs(diff) > 50) { if (diff > 0) this.nextIngredient(); else this.prevIngredient(); } }, { passive: true });
            },
            
            nextIngredient() { const cards = document.querySelectorAll('.ingredient-card'); if (this.currentIngredientIndex < cards.length - 1) this.goToIngredient(this.currentIngredientIndex + 1); },
            prevIngredient() { if (this.currentIngredientIndex > 0) this.goToIngredient(this.currentIngredientIndex - 1); },
            goToIngredient(index) {
                const cards = document.querySelectorAll('.ingredient-card');
                if (index < 0 || index >= cards.length) return;
                this.currentIngredientIndex = index;
                const wrapper = document.getElementById('ingredient-cards');
                if (wrapper) wrapper.style.transform = `translateX(-${index * 100}%)`;
                document.querySelectorAll('.carousel-dot').forEach((dot, i) => dot.classList.toggle('active', i === index));
                const prev = document.getElementById('carousel-prev');
                const next = document.getElementById('carousel-next');
                if (prev) prev.disabled = index === 0;
                if (next) next.disabled = index === cards.length - 1;
            },
            
            toggleExplainer() { document.getElementById('score-explainer')?.classList.toggle('visible'); },
            
            saveSettings() {
                // BUG #11: Simplified profile - removed email and dietary preferences
                this.userSettings = {
                    name: document.getElementById('setting-name').value,
                    allergies: document.getElementById('setting-allergies').value
                };
                localStorage.setItem('user_settings', JSON.stringify(this.userSettings));
                alert('Settings saved! ‚úì');
            },

            clearAllData() {
                if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                    localStorage.clear();
                    alert('All data cleared. Reloading app...');
                    location.reload();
                }
            },

            // Onboarding Flow
            nextOnboarding() {
                const currentScreen = document.getElementById(`onboarding-${this.onboardingStep}`);
                currentScreen.classList.remove('active');
                
                this.onboardingStep++;
                const nextScreen = document.getElementById(`onboarding-${this.onboardingStep}`);
                nextScreen.classList.add('active');
            },

            completeOnboarding() {
                localStorage.setItem('onboarding_complete', 'true');
                this.showView('home');
            },

            // View Management
            showView(viewName) {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                
                const view = document.getElementById(`view-${viewName}`);
                if (view) {
                    view.classList.add('active');
                }
                
                const navItem = document.querySelector(`.nav-item[onclick*="${viewName}"]`);
                if (navItem) {
                    navItem.classList.add('active');
                }
                
                this.currentView = viewName;
                
                // Scanner view specific logic (v1.2.0)
                if (viewName === 'scanner') {
                    document.getElementById('mode-badge')?.classList.add('visible');
                    document.getElementById('scanner-bottom-bar')?.classList.add('visible');
                    this.updateModeUI();
                    this.photoAttempts = 0;
                    this.capturedImages = []; // Reset captured images
                    this.renderCapturedImages();
                    this.updatePhotoCountBadge();
                    // v1.2.0: Auto-start camera (removed Start Camera button)
                    setTimeout(() => this.startCamera(), 300);
                    // v1.2.2: Show mini history on scanner page
                    this.updateMiniHistory();
                } else {
                    document.getElementById('mode-badge')?.classList.remove('visible');
                    document.getElementById('mode-menu')?.classList.remove('visible');
                    document.getElementById('scanner-bottom-bar')?.classList.remove('visible');
                    document.getElementById('scanner-mini-history')?.classList.remove('visible');
                    // Stop camera when leaving scanner
                    this.stopCamera();
                }
                
                // Load settings when viewing settings page
                if (viewName === 'settings') {
                    this.loadSettings();
                }
            },

            // v1.2.1: setScanMode() removed - using selectMode() only

            // v1.2.0: Camera Functions - Auto-start, no toggle button
            async startCamera() {
                if (this.cameraActive) return; // Already running
                
                // C2: Check if permission was previously denied
                if (this.cameraPermissionDenied) {
                    this.showError('CAMERA_DENIED');
                    return;
                }
                
                const video = document.getElementById('camera-video');
                const placeholder = document.getElementById('camera-placeholder');
                const overlay = document.getElementById('camera-overlay');

                try {
                    this.stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } } 
                    });
                    video.srcObject = this.stream;
                    video.style.display = 'block';
                    placeholder.style.display = 'none';
                    overlay.style.display = 'flex';
                    this.cameraActive = true;
                    this.hideError();  // Clear any previous errors
                    
                    // Start barcode detection if in barcode mode
                    if (this.scanMode === 'barcode') {
                        this.startBarcodeDetection();
                    }
                    
                    // Update scan guide based on mode
                    const guideText = document.getElementById('scan-guide-text');
                    if (guideText) {
                        guideText.textContent = this.scanMode === 'barcode' 
                            ? 'üìä Point at barcode for instant lookup'
                            : 'üìã Point at ingredient list';
                    }
                } catch (err) {
                    // BUG #2: Show actionable error instead of generic alert
                    this.logError('CAMERA_ERROR', { name: err.name, message: err.message });
                    if (err.name === 'NotAllowedError') {
                        this.cameraPermissionDenied = true; // C2: Cache denial
                        this.showError('CAMERA_DENIED');
                    } else if (err.name === 'NotFoundError') {
                        this.showError('CAMERA_UNAVAILABLE');
                    } else {
                        this.showError('CAMERA_UNAVAILABLE');
                    }
                    console.error('Camera error:', err);
                }
            },
            
            // Legacy alias for compatibility
            toggleCamera() {
                if (this.cameraActive) {
                    this.stopCamera();
                } else {
                    this.startCamera();
                }
            },

            // BUG #2: Error display function
            // v1.2.0: Enhanced error display with auto-switch support
            showError(errorType) {
                const error = ERROR_CODES[errorType];
                if (!error) {
                    console.error('Unknown error type:', errorType);
                    return;
                }
                
                // Log error
                this.logError(error.code, { type: errorType });
                
                // Determine fallback button based on error type
                let fallbackButton = '';
                if (error.fallback === 'switchToIngredients') {
                    // v1.2.0: Auto-switch to ingredients mode
                    fallbackButton = `
                        <button class="btn btn-secondary" onclick="app.switchToIngredientsMode()" style="margin-bottom: 12px; width: 100%;">
                            ${error.fallbackText || 'üìã Scan Ingredients Instead'}
                        </button>
                    `;
                } else if (error.fallback) {
                    fallbackButton = `
                        <p style="font-size: 14px; color: #64748B; margin-bottom: 16px;">
                            ${error.fallback}
                        </p>
                        <button class="btn btn-secondary" onclick="app.useGalleryFallback()" style="margin-bottom: 12px; width: 100%;">
                            üìÅ Upload from Gallery
                        </button>
                    `;
                }
                
                const html = `
                    <div style="padding: 24px; text-align: center; max-width: 400px; margin: 20px auto;">
                        <div style="font-size: 48px; margin-bottom: 16px;">${error.title.split(' ')[0]}</div>
                        <h3 style="font-size: 20px; font-weight: 700; color: #1E293B; margin-bottom: 12px;">
                            ${error.title.substring(error.title.indexOf(' ') + 1)}
                        </h3>
                        <p style="color: #64748B; margin-bottom: 24px; line-height: 1.6;">
                            ${error.message}
                        </p>
                        
                        <div style="background: #F0FDF4; padding: 16px; border-radius: 12px; margin-bottom: 20px; text-align: left;">
                            <strong style="color: #16A34A; display: block; margin-bottom: 8px;">How to fix:</strong>
                            <ul style="margin: 0; padding-left: 20px; color: #475569;">
                                ${error.actions.map(action => `<li style="margin: 6px 0;">${action}</li>`).join('')}
                            </ul>
                        </div>
                        
                        ${fallbackButton}
                        
                        <button class="btn btn-primary" onclick="app.retryCamera()" style="width: 100%;">
                            üîÑ Try Again
                        </button>
                        
                        <p style="font-size: 12px; color: #94A3B8; margin-top: 16px;">
                            Error Code: ${error.code}
                        </p>
                    </div>
                `;
                
                const resultContainer = document.getElementById('scanner-result');
                resultContainer.innerHTML = html;
                resultContainer.style.display = 'block';
            },

            // v1.2.0: Switch to ingredients mode (called from barcode not found error)
            switchToIngredientsMode() {
                this.hideError();
                this.selectMode('ingredients');
                this.showToast('Switched to Ingredients mode. Point at ingredient list.', 'success');
                // Camera is already running, just update the guide
                const guideText = document.getElementById('scan-guide-text');
                if (guideText) {
                    guideText.textContent = 'üìã Point at ingredient list - any language';
                }
            },

            hideError() {
                const resultContainer = document.getElementById('scanner-result');
                if (resultContainer) {
                    resultContainer.style.display = 'none';
                    resultContainer.innerHTML = '';
                }
            },

            retryCamera() {
                this.hideError();
                // Clear cached denial so we actually retry
                this.cameraPermissionDenied = false;
                this.startCamera();
            },

            // BUG #2: Gallery fallback handler
            useGalleryFallback() {
                this.hideError();
                document.getElementById('file-input-fallback').click();
            },

            handleGalleryUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                // Check max photos limit
                if (this.capturedImages.length >= 3) {
                    this.showToast('Maximum 3 photos allowed', 'warning');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    // v1.2.2: Open crop modal instead of adding directly
                    this.openCropModal(e.target.result);
                };
                reader.onerror = () => {
                    this.showToast('Failed to load image', 'error');
                };
                reader.readAsDataURL(file);
            },
            
            // v1.2.2: Crop Modal Functions
            openCropModal(imageData) {
                this.cropImageData = imageData;
                this.cropScale = 1;
                this.cropX = 0;
                this.cropY = 0;
                
                const modal = document.getElementById('crop-modal');
                const img = document.getElementById('crop-image');
                
                img.src = imageData;
                modal.classList.add('active');
                
                // Setup touch handlers for pinch-zoom and drag
                this.setupCropHandlers();
            },
            
            setupCropHandlers() {
                const container = document.getElementById('crop-container');
                const img = document.getElementById('crop-image');
                
                let startDistance = 0;
                let startScale = 1;
                let startX = 0;
                let startY = 0;
                let isDragging = false;
                
                // Touch start
                container.ontouchstart = (e) => {
                    if (e.touches.length === 2) {
                        // Pinch start
                        startDistance = Math.hypot(
                            e.touches[0].pageX - e.touches[1].pageX,
                            e.touches[0].pageY - e.touches[1].pageY
                        );
                        startScale = this.cropScale;
                    } else if (e.touches.length === 1) {
                        // Drag start
                        isDragging = true;
                        startX = e.touches[0].pageX - this.cropX;
                        startY = e.touches[0].pageY - this.cropY;
                    }
                };
                
                // Touch move
                container.ontouchmove = (e) => {
                    e.preventDefault();
                    if (e.touches.length === 2) {
                        // Pinch zoom
                        const distance = Math.hypot(
                            e.touches[0].pageX - e.touches[1].pageX,
                            e.touches[0].pageY - e.touches[1].pageY
                        );
                        this.cropScale = Math.max(0.5, Math.min(3, startScale * (distance / startDistance)));
                        this.updateCropTransform();
                    } else if (e.touches.length === 1 && isDragging) {
                        // Drag
                        this.cropX = e.touches[0].pageX - startX;
                        this.cropY = e.touches[0].pageY - startY;
                        this.updateCropTransform();
                    }
                };
                
                // Touch end
                container.ontouchend = () => {
                    isDragging = false;
                };
                
                // Mouse support for desktop
                let isMouseDown = false;
                container.onmousedown = (e) => {
                    isMouseDown = true;
                    startX = e.pageX - this.cropX;
                    startY = e.pageY - this.cropY;
                };
                container.onmousemove = (e) => {
                    if (isMouseDown) {
                        this.cropX = e.pageX - startX;
                        this.cropY = e.pageY - startY;
                        this.updateCropTransform();
                    }
                };
                container.onmouseup = () => { isMouseDown = false; };
                container.onmouseleave = () => { isMouseDown = false; };
                
                // Mouse wheel for zoom
                container.onwheel = (e) => {
                    e.preventDefault();
                    const delta = e.deltaY > 0 ? 0.9 : 1.1;
                    this.cropScale = Math.max(0.5, Math.min(3, this.cropScale * delta));
                    this.updateCropTransform();
                };
            },
            
            updateCropTransform() {
                const img = document.getElementById('crop-image');
                img.style.transform = `translate(${this.cropX}px, ${this.cropY}px) scale(${this.cropScale})`;
            },
            
            cancelCrop() {
                document.getElementById('crop-modal').classList.remove('active');
                this.cropImageData = null;
            },
            
            applyCrop() {
                // Delegate to the unified function
                this.applyCropForEdit();
            },
            
            // v1.2.2: Mini History Functions
            updateMiniHistory() {
                const container = document.getElementById('scanner-mini-history');
                const list = document.getElementById('mini-history-list');
                
                if (!container || !list) return;
                
                // Only show if there are scans and user hasn't hidden it
                if (this.recentScans.length === 0 || !this.miniHistoryVisible) {
                    container.classList.remove('visible');
                    return;
                }
                
                container.classList.add('visible');
                
                // Show last 3 scans
                const recentThree = this.recentScans.slice(0, 3);
                list.innerHTML = recentThree.map((scan, idx) => `
                    <div class="mini-history-item" onclick="app.viewScanFromHistory(${idx})">
                        <div class="mini-history-score">${scan.score || '?'}</div>
                        <div class="mini-history-name">${scan.name || 'Unknown'}</div>
                    </div>
                `).join('');
            },
            
            toggleMiniHistory() {
                this.miniHistoryVisible = !this.miniHistoryVisible;
                localStorage.setItem('miniHistoryVisible', this.miniHistoryVisible);
                
                const container = document.getElementById('scanner-mini-history');
                const toggle = container?.querySelector('.mini-history-toggle');
                
                if (this.miniHistoryVisible) {
                    container?.classList.add('visible');
                    if (toggle) toggle.textContent = 'Hide';
                } else {
                    container?.classList.remove('visible');
                    if (toggle) toggle.textContent = 'Show';
                }
            },
            
            viewScanFromHistory(index) {
                const scan = this.recentScans[index];
                if (scan && scan.analysis) {
                    this.stopCamera();
                    this.showAnalysis(scan.analysis);
                    this.showView('analysis');
                } else {
                    this.showToast('Scan details not available', 'warning');
                }
            },
            
            // v1.2.2: Crop an already captured image
            cropExistingImage(index) {
                if (index >= 0 && index < this.capturedImages.length) {
                    this.cropEditIndex = index;
                    this.openCropModal(this.capturedImages[index]);
                }
            },
            
            // Modified applyCrop to handle editing existing images
            applyCropForEdit() {
                // Same as applyCrop but replaces instead of adds
                const img = document.getElementById('crop-image');
                const container = document.getElementById('crop-container');
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                const containerRect = container.getBoundingClientRect();
                canvas.width = containerRect.width;
                canvas.height = containerRect.height;
                
                const tempImg = new Image();
                tempImg.onload = () => {
                    const imgRect = img.getBoundingClientRect();
                    
                    const sx = (containerRect.left - imgRect.left) / this.cropScale;
                    const sy = (containerRect.top - imgRect.top) / this.cropScale;
                    const sw = containerRect.width / this.cropScale;
                    const sh = containerRect.height / this.cropScale;
                    
                    ctx.drawImage(tempImg, 
                        Math.max(0, sx), Math.max(0, sy), 
                        Math.min(tempImg.width, sw), Math.min(tempImg.height, sh),
                        0, 0, canvas.width, canvas.height
                    );
                    
                    const croppedData = canvas.toDataURL('image/jpeg', 0.9);
                    
                    // Replace the existing image
                    if (this.cropEditIndex !== undefined && this.cropEditIndex >= 0) {
                        this.capturedImages[this.cropEditIndex] = croppedData;
                        this.renderCapturedImages();
                        this.showToast('Photo cropped! ‚úÇÔ∏è', 'success');
                        this.cropEditIndex = undefined;
                    } else {
                        // Add as new
                        this.capturedImages.push(croppedData);
                        this.renderCapturedImages();
                        document.getElementById('analyze-btn-bar').disabled = false;
                        this.showToast(`Photo ${this.capturedImages.length} cropped & added! ‚úÇÔ∏è`, 'success');
                    }
                    
                    this.cancelCrop();
                };
                tempImg.src = this.cropImageData;
            },

            stopCamera() {
                const video = document.getElementById('camera-video');
                const placeholder = document.getElementById('camera-placeholder');
                const overlay = document.getElementById('camera-overlay');
                
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
                
                if (video) video.style.display = 'none';
                if (placeholder) placeholder.style.display = 'flex';
                if (overlay) overlay.style.display = 'none';
                this.cameraActive = false;
                
                if (window.Quagga) {
                    try { Quagga.stop(); } catch(e) {}
                }
            },

            startBarcodeDetection() {
                if (!window.Quagga) return;
                
                Quagga.init({
                    inputStream: {
                        type: "LiveStream",
                        target: document.querySelector('#camera-video'),
                        constraints: {
                            facingMode: "environment"
                        }
                    },
                    decoder: {
                        readers: ["ean_reader", "ean_8_reader", "upc_reader"]
                    },
                    locate: true
                }, (err) => {
                    if (!err) {
                        Quagga.start();
                    }
                });

                Quagga.onDetected(async (result) => {
                    const barcode = result.codeResult.code;
                    console.log("Barcode detected:", barcode);
                    
                    // Stop camera and barcode detection
                    this.stopCamera();
                    
                    // Try Open Food Facts first
                    this.showLoading('Looking up product...');
                    const offData = await this.queryOpenFoodFacts(barcode);
                    
                    if (offData && offData.found) {
                        this.hideLoading();
                        const analysis = this.convertOFFToAnalysis(offData);
                        this.showAnalysis(analysis);
                        this.addToRecentScans(analysis);
                    } else {
                        this.hideLoading();
                        // BUG #4: Better error message for product not found
                        this.showError('BARCODE_NOT_FOUND');
                    }
                });
            },

            // v1.2.1: New capturePhoto() function with quality check and max limit
            capturePhoto() {
                // D3: Enforce 3-photo max
                if (this.capturedImages.length >= 3) {
                    this.showToast('Maximum 3 photos allowed', 'warning');
                    return;
                }
                
                const video = document.getElementById('camera-video');
                
                // Check video is fully ready
                if (!video || !this.cameraActive) {
                    this.showToast('Camera not ready. Please wait...', 'error');
                    return;
                }
                
                // Check video has actual content (not just a black frame)
                if (video.videoWidth === 0 || video.videoHeight === 0) {
                    this.showToast('Camera still loading...', 'warning');
                    return;
                }
                
                try {
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0);
                    
                    const imageData = canvas.toDataURL('image/jpeg', 0.9);
                    
                    // Verify we got actual image data (not empty)
                    if (imageData.length < 1000) {
                        this.showToast('Capture failed. Please try again.', 'error');
                        return;
                    }
                    
                    this.capturedImages.push(imageData);
                    this.renderCapturedImages();
                    
                    // Update badge
                    const badge = document.getElementById('photo-count-badge');
                    if (badge) {
                        badge.textContent = this.capturedImages.length;
                        badge.style.display = 'flex';
                    }
                    
                    // Enable analyze button
                    document.getElementById('analyze-btn-bar').disabled = false;
                    
                    this.showToast(`Photo ${this.capturedImages.length} captured! üì∏`, 'success');
                } catch (e) {
                    console.error('Capture error:', e);
                    this.showToast('Capture failed. Please try again.', 'error');
                }
            },

            // Old captureImage kept for backward compatibility
            captureImage() {
                this.capturePhoto(); // Redirect to new function
            },

            renderCapturedImages() {
                const container = document.getElementById('captured-images');
                container.innerHTML = this.capturedImages.map((img, idx) => `
                    <div class="captured-image" role="listitem">
                        <img src="${img}" alt="Captured image ${idx + 1}">
                        <button class="crop-image" onclick="app.cropExistingImage(${idx})" aria-label="Crop image ${idx + 1}" style="position:absolute; bottom:4px; left:4px; width:24px; height:24px; border-radius:50%; border:none; background:rgba(22,163,74,0.9); color:white; font-size:12px; cursor:pointer;">‚úÇÔ∏è</button>
                        <button class="remove-image" onclick="app.removeImage(${idx})" aria-label="Remove image ${idx + 1}">√ó</button>
                    </div>
                `).join('');
                
                // Update badge
                const badge = document.getElementById('photo-count-badge');
                if (badge) {
                    badge.textContent = this.capturedImages.length;
                    badge.style.display = this.capturedImages.length > 0 ? 'flex' : 'none';
                }
            },

            removeImage(index) {
                this.capturedImages.splice(index, 1);
                this.renderCapturedImages();
                if (this.capturedImages.length === 0) {
                    document.getElementById('analyze-btn-bar').disabled = true;
                }
            },

            // Analysis Functions
            async analyzeProduct() {
                // A3: Validate photos exist
                if (this.capturedImages.length === 0) {
                    this.showToast('Please capture at least one photo first', 'error');
                    return;
                }
                
                this.showLoading('Extracting text from images...');

                try {
                    let extractedText = '';
                    for (let i = 0; i < this.capturedImages.length; i++) {
                        this.updateLoadingMessage(`Processing image ${i + 1} of ${this.capturedImages.length}...`);
                        const result = await Tesseract.recognize(this.capturedImages[i], 'eng+hin', {
                            logger: m => console.log(m)
                        });
                        extractedText += result.data.text + '\n\n';
                    }
                    
                    // A4: Validate text was extracted
                    if (!extractedText || extractedText.trim().length < 10) {
                        this.hideLoading();
                        this.showToast('Could not read any text. Please retake with clearer photo.', 'error');
                        return;
                    }

                    this.updateLoadingMessage('Analyzing with AI...');
                    const analysis = await this.analyzeWithGemini(extractedText, this.scanMode);
                    
                    this.hideLoading();
                    this.showAnalysis(analysis);
                    this.addToRecentScans(analysis);
                    this.incrementScanCount();
                    
                    // Reset
                    this.capturedImages = [];
                    this.renderCapturedImages();
                    document.getElementById('analyze-btn-bar').disabled = true;
                    this.stopCamera();

                } catch (error) {
                    this.hideLoading();
                    // BUG #4: Better error message
                    this.showError('ANALYSIS_FAILED');
                    console.error(error);
                }
            },

            async queryOpenFoodFacts(barcode) {
                try {
                    const response = await fetch(
                        `https://world.openfoodfacts.org/api/v0/product/${barcode}.json`
                    );
                    const data = await response.json();
                    
                    if (data.status === 1) {
                        return {
                            found: true,
                            name: data.product.product_name,
                            brand: data.product.brands,
                            ingredients: data.product.ingredients_text,
                            nutriScore: data.product.nutriscore_grade,
                            nutrition: data.product.nutriments,
                            category: data.product.categories,
                            image: data.product.image_url
                        };
                    }
                } catch (error) {
                    console.error('Open Food Facts error:', error);
                }
                
                return { found: false };
            },

            convertOFFToAnalysis(offData) {
                const scoreMap = { 'a': 85, 'b': 70, 'c': 55, 'd': 40, 'e': 25 };
                const score = scoreMap[offData.nutriScore?.toLowerCase()] || 50;
                
                return {
                    productName: offData.name || 'Unknown Product',
                    brand: offData.brand || 'Unknown Brand',
                    healthScore: score,
                    scoreCategory: this.getScoreCategory(score),
                    scoreReason: `Based on Nutri-Score ${offData.nutriScore?.toUpperCase() || 'Unknown'}`,
                    allergyWarnings: this.checkAllergies(offData.ingredients),
                    macros: {
                        calories: `${offData.nutrition?.['energy-kcal_100g'] || 0} kcal`,
                        protein: `${offData.nutrition?.proteins_100g || 0}g`,
                        carbs: `${offData.nutrition?.carbohydrates_100g || 0}g`,
                        fat: `${offData.nutrition?.fat_100g || 0}g`,
                        fiber: `${offData.nutrition?.fiber_100g || 0}g`,
                        sugar: `${offData.nutrition?.sugars_100g || 0}g`
                    },
                    ingredients: this.parseIngredientsFromOFF(offData.ingredients),
                    certifications: ['Open Food Facts Verified'],
                    alternatives: [],
                    image: offData.image
                };
            },

            parseIngredientsFromOFF(ingredientsText) {
                if (!ingredientsText) return [];
                
                const ingredients = ingredientsText.split(',').slice(0, 5).map(ing => ({
                    name: ing.trim(),
                    purpose: 'Main ingredient',
                    healthImpact: 'neutral',
                    details: 'Part of product formulation',
                    source: 'Product label'
                }));
                
                return ingredients;
            },

            checkAllergies(ingredientsText) {
                if (!this.userSettings.allergies || !ingredientsText) return [];
                
                const allergyList = this.userSettings.allergies.toLowerCase().split(',').map(a => a.trim());
                const foundAllergens = [];
                
                allergyList.forEach(allergen => {
                    if (ingredientsText.toLowerCase().includes(allergen)) {
                        foundAllergens.push(allergen);
                    }
                });
                
                return foundAllergens;
            },

            // v1.2.0: Improved Gemini prompt with compound ingredient handling
            async analyzeWithGemini(extractedText, mode) {
                const GEMINI_API_KEY = 'AIzaSyBRU_8O1QXJaYnx1liyf7j3lhQwpj1fuEU';
                
                const basePrompt = mode === 'ingredients' 
                    ? `You are analyzing a food product ingredient list for consumer health education.

EXTRACTED TEXT FROM IMAGE:
${extractedText}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
CRITICAL EXTRACTION RULES - READ CAREFULLY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

1. ONLY extract from the "Ingredients:" section
2. Ingredients are separated by: COMMAS (,) SEMICOLONS (;) BULLETS (‚Ä¢) or NEWLINES
3. KEEP COMPOUND INGREDIENTS TOGETHER AS ONE UNIT:
   ‚úì "Sodium Benzoate" ‚Üí "Sodium Benzoate" (NOT "Sodium" + "Benzoate")
   ‚úì "Palm Oil" ‚Üí "Palm Oil" (NOT "Palm" + "Oil")
   ‚úì "Citric Acid" ‚Üí "Citric Acid"
   ‚úì "Monosodium Glutamate" ‚Üí "Monosodium Glutamate"
   ‚úì "Modified Corn Starch" ‚Üí "Modified Corn Starch"

4. STOP extraction when you see ANY of these:
   - "Contains:", "Allergens:", "May Contain:"
   - "Nutrition Facts", "Nutritional Information"
   - "Net Weight", "Net Wt", "Net Contents"
   - "Best Before", "Expiry", "Use By", "Mfg Date"
   - "Storage:", "Directions:", "Instructions:"
   - "Manufactured by:", "Packed by:", "Marketed by:"

5. KNOWN COMPOUND INGREDIENTS (keep together):
   - Preservatives: Sodium Benzoate, Potassium Sorbate, Calcium Propionate
   - Acids: Citric Acid, Ascorbic Acid, Tartaric Acid, Malic Acid, Lactic Acid
   - Oils: Palm Oil, Sunflower Oil, Coconut Oil, Vegetable Oil, Soybean Oil, Rice Bran Oil
   - Starches: Modified Starch, Corn Starch, Tapioca Starch, Modified Corn Starch
   - Flavors: Natural Flavors, Artificial Flavors, Nature Identical Flavoring
   - Additives: Raising Agent, Emulsifying Agent, Stabilizer, Thickener
   - E-numbers: E621, E320, E330 (keep code with name if both present)
   - INS codes: INS 621, INS 320 (keep code with name if both present)

6. COMPLETELY IGNORE:
   - Numbers alone (200g, 500ml, %)
   - Dates in any format
   - Brand names, company names
   - Nutrition values (calories, protein, etc.)
   - Serving size information

Respond ONLY with valid JSON:
{
  "detectedLanguage": "English/Hindi/Tamil/Telugu/Other",
  "productName": "Unknown (Ingredient Scan)",
  "category": "food",
  "healthScore": 0-100,
  "scoreCategory": "excellent/good/fair/poor/bad",
  "scoreReason": "Brief 1-2 sentence explanation",
  "confidence": "high/medium/low",
  "allergyWarnings": ["list of common allergens detected"],
  "ingredients": [
    {
      "name": "Ingredient Name (keep compound names together)",
      "purpose": "What this ingredient does",
      "healthImpact": "positive/neutral/negative",
      "safetyLevel": "generally-safe/use-sparingly/limit-intake/avoid-if-sensitive",
      "details": "2-3 sentence explanation in simple language",
      "source": "Natural/Synthetic/Processed"
    }
  ],
  "trustBadges": [
    {"type": "verified/caution/warning", "text": "Badge text", "standard": "WHO/FSSAI/FDA/EFSA"}
  ],
  "overallVerdict": "Brief recommendation"
}

CONFIDENCE RULES:
- "high": Clear image, all ingredients readable, standard format
- "medium": Some text unclear, most ingredients detected
- "low": Poor quality, many ingredients may be missed

HEALTH SCORE RULES:
- 80-100 (excellent): Minimal processing, no concerning additives
- 60-79 (good): Some processing, minor additives
- 40-59 (fair): Moderate processing, some concerning ingredients
- 20-39 (poor): Highly processed, multiple concerning additives
- 0-19 (bad): Many harmful additives, very low nutritional value

Be accurate and educational. Avoid alarmist language.`
                    : `Analyze this food product label for Indian consumers.

Text from product label:
${extractedText}

CRITICAL: Keep compound ingredient names together (e.g., "Sodium Benzoate" not "Sodium" + "Benzoate").

Respond ONLY with valid JSON:
{
  "productName": "Product name",
  "brand": "Brand name",
  "category": "food",
  "healthScore": 0-100,
  "scoreCategory": "excellent/good/fair/poor/bad",
  "scoreReason": "Brief explanation",
  "confidence": "high/medium/low",
  "allergyWarnings": ["allergens found"],
  "macros": {
    "calories": "value per 100g or null",
    "protein": "value or null",
    "carbs": "value or null",
    "fat": "value or null",
    "fiber": "value or null",
    "sugar": "value or null"
  },
  "ingredients": [
    {
      "name": "ingredient name",
      "purpose": "what it does",
      "healthImpact": "positive/neutral/negative",
      "safetyLevel": "generally-safe/use-sparingly/limit-intake/avoid-if-sensitive",
      "details": "explanation in simple language",
      "source": "Natural/Synthetic/Processed"
    }
  ],
  "certifications": ["FSSAI", "organic", etc],
  "trustBadges": [
    {"type": "verified/caution/warning", "text": "badge text", "standard": "WHO/FSSAI/FDA"}
  ]
}`;

                try {
                    if (GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY_HERE') {
                        throw new Error('API key not set');
                    }
                    
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: basePrompt }] }],
                                generationConfig: {
                                    temperature: 0.7,
                                    maxOutputTokens: 4096
                                }
                            })
                        }
                    );
                    
                    // Check for network/API errors
                    if (!response.ok) {
                        console.error('API response not ok:', response.status);
                        throw new Error(`API error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // Check for valid response structure
                    if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                        console.error('Invalid API response structure:', data);
                        throw new Error('Invalid response from AI');
                    }
                    
                    let text = data.candidates[0].content.parts[0].text;
                    text = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                    const jsonMatch = text.match(/\{[\s\S]*\}/);
                    
                    if (jsonMatch) {
                        const rawAnalysis = JSON.parse(jsonMatch[0]);
                        // v1.2.0: Post-processing validation
                        return this.validateAndCleanAnalysis(rawAnalysis);
                    }
                    
                    throw new Error('Could not parse response');
                } catch (error) {
                    console.error('Gemini API error:', error);
                    this.logError('ERR_API', { message: error.message });
                    // v1.2.1: No demo fallback - throw real error
                    throw new Error('Analysis failed. Please check your internet connection and try again.');
                }
            },

            // v1.2.0: Post-processing validation for AI results
            validateAndCleanAnalysis(analysis) {
                // Clean ingredients
                if (analysis.ingredients && Array.isArray(analysis.ingredients)) {
                    analysis.ingredients = this.cleanIngredients(analysis.ingredients);
                }
                
                // Validate health score
                if (typeof analysis.healthScore === 'number') {
                    analysis.healthScore = Math.max(0, Math.min(100, Math.round(analysis.healthScore)));
                } else {
                    analysis.healthScore = 50; // Default if missing
                }
                
                // Ensure score category matches score
                analysis.scoreCategory = this.getScoreCategory(analysis.healthScore);
                
                // Validate confidence
                if (!['high', 'medium', 'low'].includes(analysis.confidence)) {
                    analysis.confidence = 'medium';
                }
                
                // Validate macros (all-or-nothing)
                if (analysis.macros) {
                    if (!this.hasCompleteNutrition(analysis.macros)) {
                        analysis.macros = null; // Remove incomplete nutrition
                    }
                }
                
                // Ensure arrays exist
                analysis.allergyWarnings = analysis.allergyWarnings || [];
                analysis.trustBadges = analysis.trustBadges || [];
                
                return analysis;
            },

            // v1.2.0: Clean and validate ingredients list
            cleanIngredients(ingredients) {
                // Patterns to exclude (non-ingredients)
                const excludePatterns = [
                    /^net\s*(weight|wt|contents?)/i,
                    /^best\s*before/i,
                    /^(mfg|exp|use\s*by)\s*date/i,
                    /^batch/i,
                    /^lot/i,
                    /^\d+\s*(g|ml|kg|l|kcal|cal)$/i,
                    /^\d+%$/,
                    /^contains?:?$/i,
                    /^allergen/i,
                    /^ingredients?:?$/i,
                    /^nutrition/i,
                    /^storage/i,
                    /^directions?/i,
                    /^manufactured/i,
                    /^packed\s*by/i,
                    /^marketed\s*by/i
                ];
                
                return ingredients
                    .filter(ing => {
                        if (!ing || !ing.name) return false;
                        const name = ing.name.trim();
                        if (name.length < 2) return false;
                        // Check against exclude patterns
                        return !excludePatterns.some(pattern => pattern.test(name));
                    })
                    .map(ing => ({
                        name: this.mergeCompoundIngredient(ing.name.trim()),
                        purpose: ing.purpose || 'Ingredient',
                        healthImpact: ing.healthImpact || 'neutral',
                        safetyLevel: ing.safetyLevel || 'generally-safe',
                        details: ing.details || 'Part of product formulation',
                        source: ing.source || 'Unknown'
                    }));
            },

            // v1.2.0: Merge compound ingredients that may have been split
            mergeCompoundIngredient(name) {
                // Known compound prefixes and their common pairs
                const compounds = {
                    'sodium': ['benzoate', 'chloride', 'bicarbonate', 'citrate', 'lactate', 'phosphate'],
                    'potassium': ['sorbate', 'chloride', 'citrate', 'benzoate'],
                    'calcium': ['carbonate', 'chloride', 'phosphate', 'propionate', 'sulfate'],
                    'citric': ['acid'],
                    'ascorbic': ['acid'],
                    'lactic': ['acid'],
                    'malic': ['acid'],
                    'tartaric': ['acid'],
                    'palm': ['oil'],
                    'sunflower': ['oil'],
                    'coconut': ['oil'],
                    'vegetable': ['oil'],
                    'soybean': ['oil'],
                    'rice': ['bran oil', 'flour'],
                    'corn': ['starch', 'syrup', 'flour'],
                    'modified': ['starch', 'corn starch', 'tapioca starch'],
                    'wheat': ['flour', 'gluten'],
                    'natural': ['flavors', 'flavours', 'color', 'colours'],
                    'artificial': ['flavors', 'flavours', 'color', 'colours']
                };
                
                // Already looks compound, return as-is
                if (name.includes(' ')) return name;
                
                // Check if this is a prefix that needs a suffix
                const lower = name.toLowerCase();
                if (compounds[lower]) {
                    // This is incomplete - but we can't fix without context
                    // Just return as-is
                }
                
                return name;
            },

            // v1.2.0: Check if nutrition data is complete (all-or-nothing)
            hasCompleteNutrition(macros) {
                if (!macros) return false;
                
                // Require all 4 core macros to display nutrition section
                const required = ['calories', 'protein', 'carbs', 'fat'];
                return required.every(key => {
                    const value = macros[key];
                    if (!value) return false;
                    if (value === 'null' || value === 'N/A' || value === '-') return false;
                    // Must have a number
                    return /\d/.test(value);
                });
            },

            // v1.2.0: Get score category from numeric score
            getScoreCategory(score) {
                if (score >= 80) return 'excellent';
                if (score >= 60) return 'good';
                if (score >= 40) return 'fair';
                if (score >= 20) return 'poor';
                return 'bad';
            },

            // v1.2.0: Error logging to localStorage
            logError(code, details = {}) {
                try {
                    const errors = JSON.parse(localStorage.getItem('eitaki_error_log') || '[]');
                    errors.push({
                        code,
                        details,
                        timestamp: Date.now(),
                        url: window.location.href
                    });
                    // Keep only last 50 errors
                    localStorage.setItem('eitaki_error_log', JSON.stringify(errors.slice(-50)));
                } catch (e) {
                    console.error('Failed to log error:', e);
                }
            },

            // v1.2.1: getDemoAnalysis() removed - no fake results

            showAnalysis(analysis) {
                const container = document.getElementById('analysis-content');
                const scoreClass = `score-${analysis.scoreCategory || 'fair'}`;

                // BUG #5: Calculate and display confidence
                // AI returns "high/medium/low", convert to numeric for display
                let confidenceValue = analysis.confidence;
                let confidencePercent, confidenceColor, confidenceLabel;
                
                if (typeof confidenceValue === 'string') {
                    // Convert string to percent
                    if (confidenceValue === 'high') {
                        confidencePercent = 90;
                        confidenceColor = '#10B981';
                        confidenceLabel = 'High';
                    } else if (confidenceValue === 'medium') {
                        confidencePercent = 75;
                        confidenceColor = '#F59E0B';
                        confidenceLabel = 'Medium';
                    } else {
                        confidencePercent = 60;
                        confidenceColor = '#EF4444';
                        confidenceLabel = 'Low';
                    }
                } else if (typeof confidenceValue === 'number') {
                    confidencePercent = confidenceValue;
                    confidenceColor = confidenceValue >= 85 ? '#10B981' : confidenceValue >= 75 ? '#F59E0B' : '#EF4444';
                    confidenceLabel = confidenceValue >= 85 ? 'High' : confidenceValue >= 75 ? 'Medium' : 'Low';
                } else {
                    // Default
                    confidencePercent = 75;
                    confidenceColor = '#F59E0B';
                    confidenceLabel = 'Medium';
                }

                let trustBadgesHTML = '';
                if (analysis.trustBadges && analysis.trustBadges.length > 0) {
                    trustBadgesHTML = `
                        <div class="trust-badges" style="margin-top: 16px;">
                            ${analysis.trustBadges.map(badge => `
                                <span class="trust-badge ${badge.type}">
                                    ${badge.type === 'verified' ? '‚úì' : badge.type === 'caution' ? '‚ö†' : '‚ö†'}
                                    ${badge.text}
                                </span>
                            `).join('')}
                        </div>
                    `;
                }

                let allergiesHTML = '';
                if (analysis.allergyWarnings && analysis.allergyWarnings.length > 0) {
                    allergiesHTML = `
                        <div class="alert-box" role="alert">
                            <strong>‚ö†Ô∏è Allergy Alert:</strong> Contains ${analysis.allergyWarnings.join(', ')}
                        </div>
                    `;
                }

                // BUG #5: Confidence badge HTML
                const confidenceBadgeHTML = `
                    <div style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: white; border-radius: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-top: 12px;">
                        <div style="width: 8px; height: 8px; border-radius: 50%; background: ${confidenceColor};"></div>
                        <span style="font-size: 13px; font-weight: 600; color: #1E293B;">
                            ${confidenceLabel} Confidence (${confidencePercent}%)
                        </span>
                    </div>
                `;

                // BUG #5: Low confidence disclaimer
                const confidenceDisclaimerHTML = confidencePercent < 80 ? `
                    <div style="background: #FEF3C7; border-left: 4px solid #F59E0B; padding: 12px; border-radius: 8px; margin-top: 16px;">
                        <strong style="color: #92400E;">‚ö†Ô∏è Note:</strong>
                        <span style="color: #78350F; font-size: 14px;">
                            Some ingredients may not have been detected clearly. Double-check the packaging.
                        </span>
                    </div>
                ` : '';

                let macrosHTML = '';
                if (analysis.macros) {
                    macrosHTML = `
                        <div class="analysis-section">
                            <h2 class="section-title">üìä Nutrition Facts</h2>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                                ${Object.entries(analysis.macros).map(([key, value]) => `
                                    <div style="background: var(--ice-blue); padding: 12px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 18px; font-weight: 700; color: var(--slate);">${value}</div>
                                        <div style="font-size: 12px; color: var(--light-slate); text-transform: capitalize;">${key}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                let verdictHTML = '';
                if (analysis.overallVerdict) {
                    verdictHTML = `
                        <div style="background: var(--ice-blue); padding: 20px; border-radius: 12px; text-align: center; font-size: 18px; font-weight: 700; margin-bottom: 20px;">
                            ${analysis.overallVerdict}
                        </div>
                    `;
                }

                // BUG #6: Score explanation section
                const scoreExplanationHTML = `
                    <div style="margin-top: 16px;">
                        <button class="btn btn-secondary" onclick="app.toggleScoreDetails()" style="width: 100%; font-size: 14px;">
                            üìä Why this score? (Tap to expand)
                        </button>
                        
                        <div id="score-details" style="display: none; margin-top: 16px; background: #F0FDF4; padding: 16px; border-radius: 12px;">
                            <h4 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: #16A34A;">
                                Score Breakdown
                            </h4>
                            
                            <div style="margin-bottom: 16px;">
                                <strong style="color: #16A34A; display: block; margin-bottom: 8px;">üìä How we calculate:</strong>
                                <ul style="margin: 0; padding-left: 20px; color: #475569; font-size: 14px;">
                                    <li>Processing Level (20%)</li>
                                    <li>Nutrient Quality (35%)</li>
                                    <li>Ingredient Quality (30%)</li>
                                    <li>Transparency (15%)</li>
                                </ul>
                            </div>
                            
                            <div style="background: white; padding: 12px; border-radius: 8px; font-size: 13px; color: #64748B;">
                                <strong style="color: #1E293B;">Sources:</strong> WHO, FSSAI, FDA, peer-reviewed research.
                                <a href="#" onclick="app.showMethodology(); return false;" style="color: #16A34A; text-decoration: underline;">
                                    View full methodology
                                </a>
                            </div>
                        </div>
                    </div>
                `;

                // v1.2.1: Save to My Scans prompt (localStorage, no Firebase)
                const savePromptHTML = `
                    <div style="background: linear-gradient(135deg, #16A34A, #14B8A6); padding: 24px; border-radius: 16px; margin-top: 20px; color: white; text-align: center;">
                        <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 12px;">
                            üíæ Save This Scan?
                        </h3>
                        <p style="font-size: 14px; margin-bottom: 20px; opacity: 0.9;">
                            Keep this analysis in your personal scan history for quick access later.
                        </p>
                        
                        <div style="display: flex; gap: 12px; justify-content: center;">
                            <button class="btn" onclick="app.saveToMyScans()" style="background: white; color: #16A34A; flex: 1; max-width: 150px;">
                                üíæ Save
                            </button>
                            <button class="btn" onclick="app.skipSave()" style="background: rgba(255,255,255,0.2); color: white; flex: 1; max-width: 150px;">
                                Skip
                            </button>
                        </div>
                    </div>
                `;

                // BUG #9: Healthier alternatives (only if score < 50)
                const alternativesHTML = analysis.healthScore < 50 ? `
                    <div style="background: linear-gradient(135deg, #F0FDF4, #DCFCE7); padding: 20px; border-radius: 16px; margin-top: 24px;">
                        <h3 style="font-size: 18px; font-weight: 700; color: #166534; margin-bottom: 16px;">
                            üíö Looking for Healthier Options?
                        </h3>
                        <p style="font-size: 14px; color: #15803D; margin-bottom: 16px;">
                            Consider products with fewer processed ingredients and lower sodium/sugar content.
                        </p>
                        <p style="font-size: 12px; color: #15803D; font-style: italic;">
                            Feature coming soon: We'll suggest specific alternatives based on community data.
                        </p>
                    </div>
                ` : '';

                container.innerHTML = `
                    <div class="product-header">
                        ${analysis.image ? `<img src="${analysis.image}" alt="${analysis.productName}" style="width: 100%; max-height: 200px; object-fit: contain; margin-bottom: 16px; border-radius: 8px;">` : ''}
                        <h1 class="product-name">${analysis.productName}</h1>
                        ${analysis.brand ? `<p class="product-brand">${analysis.brand}</p>` : ''}
                        ${analysis.detectedLanguage ? `<p class="product-brand">Detected language: ${analysis.detectedLanguage}</p>` : ''}
                        
                        ${confidenceDisclaimerHTML}
                        
                        <div class="health-score-card">
                            <div class="score-main">
                                <div class="score-circle ${scoreClass}">
                                    ${analysis.healthScore}
                                    <div class="score-label">${analysis.scoreCategory}</div>
                                </div>
                                <div class="score-details">
                                    <div class="score-title">Health Score</div>
                                    <p class="score-desc">${analysis.scoreReason}</p>
                                </div>
                            </div>
                            ${confidenceBadgeHTML}
                            ${trustBadgesHTML}
                            ${scoreExplanationHTML}
                        </div>

                        ${allergiesHTML}
                        ${verdictHTML}
                    </div>

                    ${macrosHTML}

                    <div class="analysis-section">
                        <h2 class="section-title">üî¨ Ingredients Deep Dive</h2>
                        <div class="ingredient-list">
                            ${(analysis.ingredients || []).map(ing => `
                                <div class="ingredient-item">
                                    <div class="ingredient-header">
                                        <span class="ingredient-name">${ing.name}</span>
                                        <span class="impact-badge impact-${ing.healthImpact}">
                                            ${ing.healthImpact === 'positive' ? '‚úì Good' : ing.healthImpact === 'negative' ? '‚ö† Caution' : 'Neutral'}
                                        </span>
                                    </div>
                                    ${ing.readabilityIssue ? `<div class="alert-box" style="margin: 8px 0; font-size: 12px; padding: 8px;">‚ö†Ô∏è ${ing.readabilityIssue}</div>` : ''}
                                    <div class="ingredient-purpose"><strong>Purpose:</strong> ${ing.purpose}</div>
                                    <div class="ingredient-detail">${ing.details}</div>
                                    <div style="font-size: 12px; color: var(--light-slate); margin-top: 8px;">
                                        <strong>Source:</strong> ${ing.source}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    ${analysis.certifications && analysis.certifications.length > 0 ? `
                        <div class="analysis-section">
                            <h2 class="section-title">‚úì Certifications & Standards</h2>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                ${analysis.certifications.map(cert => `
                                    <span style="background: var(--ice-blue); padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600;">
                                        ${cert}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    ${alternativesHTML}
                    ${savePromptHTML}

                    <div class="disclaimer">
                        <strong>‚ö†Ô∏è Important Disclaimer:</strong> This analysis is for educational purposes only and should not be considered medical advice. 
                        Information is based on detected ${this.scanMode === 'ingredients' ? 'ingredients' : 'product data'} and may not be 100% accurate. 
                        Always verify ingredients on the actual product packaging. May miss allergens if not clearly visible in scan. 
                        We are not liable for errors in detection or analysis. Consult healthcare professionals for specific dietary needs.
                        <br><br>
                        <strong>Data Sources:</strong> ${analysis.image ? 'Open Food Facts, ' : ''}AI analysis (Gemini), WHO, FSSAI, peer-reviewed research.
                        Last analyzed: ${new Date().toLocaleDateString()}
                    </div>

                    <div style="text-align: center; margin-top: 24px;">
                        <button class="btn btn-primary" onclick="app.showView('home')" style="margin-right: 12px;">
                            üè† Home
                        </button>
                        <button class="btn btn-secondary" onclick="app.showView('scanner')">
                            üì∏ Scan Another
                        </button>
                    </div>
                `;

                this.showView('analysis');
                
                // Show footer with disclaimer
                document.getElementById('app-footer').style.display = 'block';
            },

            // BUG #6: Toggle score details
            toggleScoreDetails() {
                const details = document.getElementById('score-details');
                if (details) {
                    details.style.display = details.style.display === 'none' ? 'block' : 'none';
                }
            },

            // BUG #8: Contribution handlers
            // v1.2.1: Save to My Scans (localStorage only, no Firebase)
            saveToMyScans() {
                try {
                    // Get the current analysis from the displayed content
                    const productName = document.querySelector('.product-name')?.textContent || 'Unknown Product';
                    const healthScore = document.querySelector('.score-circle')?.textContent?.trim() || '??';
                    const scoreCategory = document.querySelector('.score-label')?.textContent || 'unknown';
                    
                    const scan = {
                        id: Date.now(),
                        name: productName,
                        score: parseInt(healthScore) || 0,
                        category: scoreCategory,
                        date: new Date().toISOString(),
                        mode: this.scanMode
                    };
                    
                    // Save to localStorage
                    let savedScans = JSON.parse(localStorage.getItem('my_saved_scans') || '[]');
                    savedScans.unshift(scan);
                    savedScans = savedScans.slice(0, 20); // Keep last 20
                    localStorage.setItem('my_saved_scans', JSON.stringify(savedScans));
                    
                    this.showToast('Saved to My Scans! üíæ', 'success');
                    
                    // Navigate home after brief delay
                    setTimeout(() => this.showView('home'), 1500);
                } catch (e) {
                    console.error('Failed to save scan:', e);
                    this.showToast('Failed to save. Please try again.', 'error');
                }
            },

            skipSave() {
                // Simply go home - no guilt
                this.showView('home');
            },

            // Legacy functions removed
            addToDatabase() {
                this.showToast('Community contributions coming in Phase 1.5!', 'info');
            },
            skipContribution() {
                this.skipSave();
            },

            // v1.2.1: promptSignupIfContributing removed - not needed without Firebase

            // BUG #11: Update scan history display
            updateScanHistoryDisplay() {
                const historyContainer = document.getElementById('scan-history-list');
                if (!historyContainer) return;
                
                if (this.recentScans.length === 0) {
                    historyContainer.innerHTML = '<p style="color: var(--light-slate); font-size: 14px;">No scans yet. Start scanning products!</p>';
                    return;
                }
                
                historyContainer.innerHTML = this.recentScans.map(scan => `
                    <div style="background: var(--ice-blue); padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                        <div style="font-weight: 600; color: var(--slate);">${scan.name}</div>
                        <div style="font-size: 12px; color: var(--light-slate);">
                            Score: ${scan.score} ‚Ä¢ ${new Date(scan.timestamp).toLocaleDateString()}
                        </div>
                    </div>
                `).join('');
            },

            // BUG #13: Show About page
            showAbout() {
                this.showView('about');
            },

            // BUG #6: Show methodology modal
            showMethodology() {
                const modal = `
                    <div class="modal active" id="methodology-modal" onclick="if(event.target === this) app.closeMethodologyModal()">
                        <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
                            <h3 class="modal-title">üî¨ How We Calculate Health Scores</h3>
                            <div style="font-size: 14px; line-height: 1.8; color: #374151;">
                                <p style="margin-bottom: 16px;">
                                    Our health scores are based on a <strong>4-pillar framework</strong> developed using WHO, FSSAI, and peer-reviewed research:
                                </p>
                                
                                <div style="background: #F0FDF4; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                                    <strong style="color: #16A34A;">üìä Score Breakdown:</strong>
                                    <ul style="margin: 12px 0 0 20px;">
                                        <li><strong>Processing Level (20%)</strong>: How processed is the food?</li>
                                        <li><strong>Nutrient Quality (35%)</strong>: Good vs bad nutrients</li>
                                        <li><strong>Ingredient Quality (30%)</strong>: Safety of individual ingredients</li>
                                        <li><strong>Transparency (15%)</strong>: Label clarity and certifications</li>
                                    </ul>
                                </div>
                                
                                <div style="background: #FEF3C7; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                                    <strong style="color: #92400E;">‚ö†Ô∏è Important Notes:</strong>
                                    <ul style="margin: 12px 0 0 20px;">
                                        <li>Scores are educational, not medical advice</li>
                                        <li>Individual health needs vary</li>
                                        <li>Always consult healthcare professionals</li>
                                    </ul>
                                </div>
                                
                                <p style="font-size: 13px; color: #6B7280;">
                                    <strong>Sources:</strong> WHO guidelines, FSSAI standards, FDA regulations, EFSA opinions, peer-reviewed research (PubMed)
                                </p>
                            </div>
                            <div style="margin-top: 20px; text-align: center;">
                                <button class="btn btn-primary" onclick="app.closeMethodologyModal()">Got it!</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modal);
            },

            closeMethodologyModal() {
                const modal = document.getElementById('methodology-modal');
                if (modal) modal.remove();
            },

            // Legal page placeholders
            showPrivacyPolicy() {
                alert('üìã Privacy Policy\n\n‚Ä¢ All data stored locally on your device\n‚Ä¢ No personal data collection\n‚Ä¢ No data sharing with third parties\n‚Ä¢ Anonymous analytics only\n\nFull privacy policy coming soon!');
            },

            showTerms() {
                alert('üìã Terms of Service\n\n‚Ä¢ Eitaki is for educational purposes only\n‚Ä¢ Not medical advice\n‚Ä¢ Use at your own risk\n‚Ä¢ Always verify with product packaging\n\nFull terms coming soon!');
            },

            // Utility Functions
            incrementScanCount() {
                this.scanCount++;
                localStorage.setItem('scan_count', this.scanCount.toString());
                
                // Check if should prompt for email verification (after 5 scans)
                if (this.scanCount === 5 && !this.emailVerified) {
                    // Could show email modal here, but keeping it progressive for now
                }
            },

            addToRecentScans(analysis) {
                // C1: Don't save ingredients-only scans to history
                if (this.scanMode === 'ingredients' || 
                    analysis.productName?.includes('Unknown') ||
                    analysis.productName?.includes('ingredients only')) {
                    console.log('Ingredients-only scan - not saving to history');
                    return;
                }
                
                const recent = {
                    name: analysis.productName,
                    brand: analysis.brand,
                    score: analysis.healthScore,
                    timestamp: Date.now()
                };
                
                this.recentScans.unshift(recent);
                this.recentScans = this.recentScans.slice(0, 5); // Keep only 5
                localStorage.setItem('recent_scans', JSON.stringify(this.recentScans));
                this.renderRecentScans();
                this.updateScanHistoryDisplay();  // BUG #11: Update settings page
            },

            loadRecentScans() {
                try {
                    const saved = localStorage.getItem('recent_scans');
                    if (saved) {
                        this.recentScans = JSON.parse(saved);
                        this.renderRecentScans();
                    }
                } catch (e) {
                    console.error('Failed to load recent scans:', e);
                    this.recentScans = [];
                }
            },

            renderRecentScans() {
                if (this.recentScans.length === 0) return;
                
                const container = document.getElementById('recent-scans-container');
                const itemsContainer = document.getElementById('recent-items');
                
                if (!container || !itemsContainer) return; // Null check
                
                container.style.display = 'block';
                itemsContainer.innerHTML = this.recentScans.map(scan => `
                    <div class="recent-item">
                        ${scan.name || 'Unknown Product'}
                    </div>
                `).join('');
            },

            // Donation Functions
            donate(amount) {
                alert(`Thank you for your support! ‚Çπ${amount} donation feature coming soon. For now, you can support us by sharing Eitaki with friends! üíö`);
            },

            donateCustom() {
                const amount = prompt('Enter donation amount (‚Çπ):');
                if (amount && !isNaN(amount)) {
                    this.donate(amount);
                }
            },

            // Modal Functions
            closeModal() {
                document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
            },

            // v1.2.1: showSearchModal(), showEmailModal(), sendVerificationCode() removed - Phase 1.5 features

            // Loading Functions
            showLoading(message) {
                document.getElementById('loading-message').textContent = message;
                document.getElementById('loading-overlay').classList.add('active');
            },

            updateLoadingMessage(message) {
                document.getElementById('loading-message').textContent = message;
            },

            hideLoading() {
                document.getElementById('loading-overlay').classList.remove('active');
            }
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });

        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:application/javascript,');
        }
    </script>
</body>
</html>
